---
/**
 * BlogLayout.astro
 *
 * Layout for blog pages with:
 * - Light mode by default (trust + readability for health content)
 * - Dark mode toggle with localStorage persistence
 * - Full SEO support (hreflang, canonical, Open Graph)
 * - Article structured data
 */
import '../styles/global.css';
import '../styles/blog.css';
import { type Language, defaultLang, getAlternateUrls, getPathWithLang, languageMetadata, translatedLanguageNames } from '../i18n';
import { SITE_CONFIG, getSignupUrlWithLang } from '../config';
import Logo from '../components/ui/Logo.astro';

interface Props {
  title: string;
  description: string;
  keywords?: string;
  lang?: Language;
  canonicalUrl?: string;
  // Article specific
  publishDate?: Date;
  updatedDate?: Date;
  author?: string;
  authorRole?: string;
  image?: string;
  imageAlt?: string;
  category?: string;
  readingTime?: number;
  // Translations
  translations?: {
    fr?: string;
    'fr-FR'?: string;
    es?: string;
    en?: string;
  };
}

const {
  title,
  description,
  keywords,
  lang = defaultLang,
  canonicalUrl,
  publishDate,
  updatedDate,
  author = 'Équipe LOWIS',
  authorRole,
  image,
  imageAlt,
  category,
  readingTime,
  translations,
} = Astro.props;

const baseUrl = SITE_CONFIG.domain;

// Language selector data - Only show fr-FR (France), en, es
// Morocco flag is for geo/pricing, NOT for language selector
const selectorLanguages: Language[] = ['fr-FR', 'en', 'es'];
const currentLangMeta = languageMetadata[lang === 'fr' ? 'fr-FR' : lang];
const currentPath = Astro.url.pathname;

// Calculate blog-specific alternate URLs
function getBlogAlternateUrls() {
  if (!translations) {
    return getAlternateUrls(Astro.url.pathname, baseUrl);
  }

  const alternates = [];

  if (translations.fr) {
    alternates.push({ hreflang: 'fr-MA', href: `${baseUrl}/blog/${translations.fr}/` });
    alternates.push({ hreflang: 'fr', href: `${baseUrl}/blog/${translations.fr}/` });
  }
  if (translations['fr-FR']) {
    alternates.push({ hreflang: 'fr-FR', href: `${baseUrl}/fr/blog/${translations['fr-FR']}/` });
  }
  if (translations.en) {
    alternates.push({ hreflang: 'en', href: `${baseUrl}/en/blog/${translations.en}/` });
  }
  if (translations.es) {
    alternates.push({ hreflang: 'es', href: `${baseUrl}/es/blog/${translations.es}/` });
  }

  return alternates;
}

const alternateUrls = getBlogAlternateUrls();

// Canonical URL
const pathname = Astro.url.pathname.endsWith('/') ? Astro.url.pathname : `${Astro.url.pathname}/`;
const computedCanonicalUrl = canonicalUrl || `${baseUrl}${pathname}`;

// Locale mapping
const localeMap: Record<Language, string> = {
  en: 'en_US',
  es: 'es_ES',
  fr: 'fr_MA',
  'fr-FR': 'fr_FR'
};

const htmlLangMap: Record<Language, string> = {
  en: 'en',
  es: 'es',
  fr: 'fr-MA',
  'fr-FR': 'fr-FR'
};

const htmlLang = htmlLangMap[lang] || lang;

// OG Image
const ogImage = image ? `${baseUrl}${image}` : `${baseUrl}/og-image.png`;

// Category labels
const categoryLabels: Record<string, Record<Language, string>> = {
  guides: { fr: 'Guide', 'fr-FR': 'Guide', es: 'Guía', en: 'Guide' },
  comparatifs: { fr: 'Comparatif', 'fr-FR': 'Comparatif', es: 'Comparativa', en: 'Comparison' },
  astuces: { fr: 'Astuces', 'fr-FR': 'Astuces', es: 'Consejos', en: 'Tips' },
  recettes: { fr: 'Recettes', 'fr-FR': 'Recettes', es: 'Recetas', en: 'Recipes' },
  temoignages: { fr: 'Témoignage', 'fr-FR': 'Témoignage', es: 'Testimonio', en: 'Testimonial' },
};

const categoryLabel = category ? categoryLabels[category]?.[lang] || category : '';

// Translation strings
const t = {
  backToBlog: { fr: 'Retour au blog', 'fr-FR': 'Retour au blog', es: 'Volver al blog', en: 'Back to blog' },
  readingTime: { fr: 'min de lecture', 'fr-FR': 'min de lecture', es: 'min de lectura', en: 'min read' },
  theme: { fr: 'Thème', 'fr-FR': 'Thème', es: 'Tema', en: 'Theme' },
  language: { fr: 'Langue', 'fr-FR': 'Langue', es: 'Idioma', en: 'Language' },
};

// Helper to get path for language change (handles blog paths correctly)
function getBlogPathForLang(targetLang: Language): string {
  // Remove current language prefix if any
  let cleanPath = currentPath
    .replace(/^\/(fr|es|en)\//, '/')  // Remove /fr/, /es/, /en/ prefix
    .replace(/^\/fr\//, '/');          // Handle /fr/ for fr-FR

  // Ensure path starts with /
  if (!cleanPath.startsWith('/')) {
    cleanPath = '/' + cleanPath;
  }

  return getPathWithLang(cleanPath, targetLang);
}

// Structured data for article
const articleStructuredData = publishDate ? {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": description,
  "image": ogImage,
  "author": {
    "@type": "Person",
    "name": author,
    ...(authorRole && { "jobTitle": authorRole })
  },
  "publisher": {
    "@type": "Organization",
    "name": "LOWIS",
    "logo": {
      "@type": "ImageObject",
      "url": `${baseUrl}/icons/logo-512.png`
    }
  },
  "datePublished": publishDate.toISOString(),
  ...(updatedDate && { "dateModified": updatedDate.toISOString() }),
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": computedCanonicalUrl
  }
} : null;
---

<!doctype html>
<html lang={htmlLang} class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    {keywords && <meta name="keywords" content={keywords} />}
    <meta name="robots" content="index, follow" />
    <meta name="author" content={author} />
    <meta name="theme-color" content="#FAFAFA" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#0F172A" media="(prefers-color-scheme: dark)" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/logo-192.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="article" />
    <meta property="og:url" content={computedCanonicalUrl} />
    <meta property="og:image" content={ogImage} />
    {imageAlt && <meta property="og:image:alt" content={imageAlt} />}
    <meta property="og:locale" content={localeMap[lang]} />
    <meta property="og:site_name" content="LOWIS Blog" />
    {publishDate && <meta property="article:published_time" content={publishDate.toISOString()} />}
    {updatedDate && <meta property="article:modified_time" content={updatedDate.toISOString()} />}

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <!-- Canonical & Alternates -->
    <link rel="canonical" href={computedCanonicalUrl} />
    {alternateUrls.map(({ hreflang, href }) => (
      <link rel="alternate" hreflang={hreflang} href={href} />
    ))}
    <link rel="alternate" hreflang="x-default" href={`${baseUrl}/blog/`} />

    <!-- Google Fonts - Non-render-blocking with preload -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- Material Symbols - Async loading -->
    <link
      rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&display=swap"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&display=swap" rel="stylesheet" />
    </noscript>

    <!-- Inter Font - Async loading (only weights actually used: 400,500,600,700,800) -->
    <link
      rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    </noscript>

    <title>{title} | LOWIS Blog</title>

    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-52G0810T4P"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-52G0810T4P');
    </script>

    <!-- Theme initialization (before render to prevent flash) -->
    <script is:inline>
      (function() {
        const stored = localStorage.getItem('lowis_blog_theme');
        // Default to light mode - only go dark if user explicitly chose it
        if (stored === 'dark') {
          document.documentElement.classList.add('dark');
        }
      })();
    </script>

    <!-- Article Structured Data -->
    {articleStructuredData && (
      <script type="application/ld+json" set:html={JSON.stringify(articleStructuredData)} />
    )}
  </head>

  <body class="blog-body font-sans antialiased">
    <!-- Blog Header -->
    <header class="blog-header">
      <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex items-center justify-between">
          <!-- Left: Logo + Back -->
          <div class="flex items-center gap-4">
            <a href={getPathWithLang('/', lang)} class="flex items-center gap-2">
              <Logo class="h-8 w-8" />
              <span class="font-bold text-lg" style="color: var(--blog-accent);">LOWIS</span>
            </a>
            <span style="color: var(--blog-border);">|</span>
            <a
              href={getPathWithLang('/blog/', lang)}
              class="text-sm font-medium hover:underline"
              style="color: var(--blog-text-secondary);"
            >
              Blog
            </a>
          </div>

          <!-- Right: Language selector + Theme toggle + CTA -->
          <div class="flex items-center gap-3">
            <!-- Language Selector -->
            <div class="relative" id="lang-switcher">
              <button
                id="lang-toggle"
                class="flex items-center gap-1.5 px-2 py-1.5 rounded-lg transition-colors"
                style="color: var(--blog-text);"
                aria-label={t.language[lang]}
                title={t.language[lang]}
              >
                <span class="text-base">{currentLangMeta.flag}</span>
                <span class="hidden sm:inline text-sm font-medium">{translatedLanguageNames[lang][lang]}</span>
                <span class="material-symbols-outlined text-sm" style="color: var(--blog-text-secondary);">expand_more</span>
              </button>
              <div
                id="lang-dropdown"
                class="absolute right-0 mt-2 w-44 rounded-xl shadow-lg border overflow-hidden opacity-0 invisible transition-all duration-200 z-50"
                style="background: var(--blog-surface); border-color: var(--blog-border);"
              >
                {selectorLanguages.map((targetLang) => {
                  const targetMeta = languageMetadata[targetLang];
                  // fr and fr-FR are both "French" - check if current page is either French variant
                  const isActive = targetLang === lang || (targetLang === 'fr-FR' && lang === 'fr');
                  const displayName = translatedLanguageNames[lang === 'fr' ? 'fr-FR' : lang][targetLang];
                  return (
                    <a
                      href={getBlogPathForLang(targetLang)}
                      class={`lang-option flex items-center gap-3 px-4 py-2.5 text-sm transition-colors ${isActive ? 'font-semibold' : ''}`}
                      style={`color: var(--blog-text); ${isActive ? 'background: var(--blog-bg);' : ''}`}
                    >
                      <span class="text-base">{targetMeta.flag}</span>
                      <span class="flex-1">{displayName}</span>
                      {isActive && <span class="material-symbols-outlined text-sm" style="color: var(--blog-accent);">check</span>}
                    </a>
                  );
                })}
              </div>
            </div>

            <!-- Theme Toggle -->
            <button
              id="theme-toggle"
              class="theme-toggle"
              aria-label={t.theme[lang]}
              title={t.theme[lang]}
            >
              <svg class="sun-icon w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
              <svg class="moon-icon w-5 h-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
              </svg>
            </button>

            <!-- CTA Button (desktop) -->
            <a
              href={getSignupUrlWithLang(lang)}
              class="hidden sm:inline-flex items-center gap-1.5 px-4 py-2 rounded-lg text-sm font-semibold text-white transition-all"
              style="background: var(--blog-accent);"
            >
              {lang === 'fr' || lang === 'fr-FR' ? 'Essai gratuit' : lang === 'es' ? 'Prueba gratis' : 'Free trial'}
              <span class="material-symbols-outlined text-lg">arrow_forward</span>
            </a>
          </div>
        </div>
      </nav>
    </header>

    <!-- Reading Progress Bar -->
    <div id="reading-progress" class="fixed top-0 left-0 h-1 z-[60] transition-all duration-150" style="background: linear-gradient(90deg, var(--blog-accent), #DC2626); width: 0%;"></div>

    <!-- Main Content -->
    <main>
      <slot />
    </main>

    <!-- Footer -->
    <footer style="background: var(--blog-surface); border-top: 1px solid var(--blog-border);" class="mt-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="flex flex-col md:flex-row items-center justify-between gap-6">
          <!-- Logo + tagline -->
          <div class="flex items-center gap-3">
            <Logo class="h-10 w-10" />
            <div>
              <span class="font-bold text-lg" style="color: var(--blog-accent);">LOWIS</span>
              <p class="text-sm" style="color: var(--blog-text-secondary);">
                {lang === 'fr' || lang === 'fr-FR' ? 'Votre coach nutrition IA' : lang === 'es' ? 'Tu coach de nutrición IA' : 'Your AI nutrition coach'}
              </p>
            </div>
          </div>

          <!-- Links -->
          <div class="flex items-center gap-6 text-sm" style="color: var(--blog-text-secondary);">
            <a href={getPathWithLang('/', lang)} class="hover:underline">
              {lang === 'fr' || lang === 'fr-FR' ? 'Accueil' : lang === 'es' ? 'Inicio' : 'Home'}
            </a>
            <a href={getPathWithLang('/blog/', lang)} class="hover:underline">
              Blog
            </a>
            <a href={getPathWithLang('/privacy/', lang)} class="hover:underline">
              {lang === 'fr' || lang === 'fr-FR' ? 'Confidentialité' : lang === 'es' ? 'Privacidad' : 'Privacy'}
            </a>
            <a href={getPathWithLang('/terms/', lang)} class="hover:underline">
              {lang === 'fr' || lang === 'fr-FR' ? 'CGU' : lang === 'es' ? 'Términos' : 'Terms'}
            </a>
          </div>
        </div>

        <!-- Copyright -->
        <div class="mt-8 pt-8 text-center text-sm" style="color: var(--blog-text-muted); border-top: 1px solid var(--blog-border);">
          © {new Date().getFullYear()} LOWIS. {lang === 'fr' || lang === 'fr-FR' ? 'Tous droits réservés.' : lang === 'es' ? 'Todos los derechos reservados.' : 'All rights reserved.'}
        </div>
      </div>
    </footer>

    <!-- Mobile CTA Sticky -->
    <div class="fixed bottom-0 left-0 right-0 z-50 p-3 sm:hidden" style="background: var(--blog-bg); border-top: 1px solid var(--blog-border);">
      <a
        href={getSignupUrlWithLang(lang)}
        class="flex items-center justify-center gap-2 w-full py-3 rounded-xl text-white font-semibold"
        style="background: linear-gradient(135deg, var(--blog-accent), #DC2626);"
      >
        {lang === 'fr' || lang === 'fr-FR' ? 'Obtenir mon plan gratuit' : lang === 'es' ? 'Obtener mi plan gratis' : 'Get my free plan'}
        <span class="material-symbols-outlined">arrow_forward</span>
      </a>
    </div>

    <!-- Theme Toggle & Progress Bar Script -->
    <script>
      // Theme Toggle
      const themeToggle = document.getElementById('theme-toggle');
      const sunIcon = themeToggle?.querySelector('.sun-icon');
      const moonIcon = themeToggle?.querySelector('.moon-icon');

      function updateIcons() {
        const isDark = document.documentElement.classList.contains('dark');
        if (sunIcon && moonIcon) {
          sunIcon.classList.toggle('hidden', isDark);
          moonIcon.classList.toggle('hidden', !isDark);
        }
      }

      // Initial icon state
      updateIcons();

      themeToggle?.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('lowis_blog_theme', isDark ? 'dark' : 'light');
        updateIcons();
      });

      // Listen for system preference changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem('lowis_blog_theme')) {
          document.documentElement.classList.toggle('dark', e.matches);
          updateIcons();
        }
      });

      // Reading Progress Bar
      const progressBar = document.getElementById('reading-progress');

      function updateProgress() {
        const scrollTop = window.scrollY;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const progress = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
        if (progressBar) {
          progressBar.style.width = `${Math.min(progress, 100)}%`;
        }
      }

      window.addEventListener('scroll', updateProgress, { passive: true });
      updateProgress(); // Initial call

      // Language Selector Dropdown
      const langToggle = document.getElementById('lang-toggle');
      const langDropdown = document.getElementById('lang-dropdown');

      langToggle?.addEventListener('click', (e) => {
        e.stopPropagation();
        const isVisible = langDropdown?.classList.contains('opacity-100');
        if (isVisible) {
          langDropdown?.classList.remove('opacity-100', 'visible');
          langDropdown?.classList.add('opacity-0', 'invisible');
        } else {
          langDropdown?.classList.remove('opacity-0', 'invisible');
          langDropdown?.classList.add('opacity-100', 'visible');
        }
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', () => {
        langDropdown?.classList.remove('opacity-100', 'visible');
        langDropdown?.classList.add('opacity-0', 'invisible');
      });

      // ============================================
      // Image Protection (disable right-click & drag)
      // ============================================

      // Disable right-click context menu on images
      document.addEventListener('contextmenu', (e) => {
        if ((e.target as HTMLElement).tagName === 'IMG') {
          e.preventDefault();
        }
      });

      // Disable drag on all images
      document.querySelectorAll('img').forEach((img) => {
        img.setAttribute('draggable', 'false');
        img.style.userSelect = 'none';
        (img.style as any).webkitUserSelect = 'none';
        (img.style as any).webkitUserDrag = 'none';
      });

      // Also handle dynamically loaded images (for lazy loading)
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (node.nodeType === 1) {
              const element = node as HTMLElement;
              if (element.tagName === 'IMG') {
                element.setAttribute('draggable', 'false');
                element.style.userSelect = 'none';
              }
              element.querySelectorAll?.('img').forEach((img) => {
                img.setAttribute('draggable', 'false');
                img.style.userSelect = 'none';
              });
            }
          });
        });
      });

      observer.observe(document.body, { childList: true, subtree: true });
    </script>
  </body>
</html>
