---
import { type Language, languages, languageMetadata, getPathWithLang, defaultLang, translatedLanguageNames } from '../i18n';
import Logo from './ui/Logo.astro';
import { getSignupUrlWithLang, getLoginUrlWithLang } from '../config';

interface Props {
  t: {
    nav: {
      features: string;
      howItWorks: string;
      pricing: string;
      faq: string;
      blog: string;
      cta: string;
      login: string;
    };
  };
  lang: Language;
}

const { t, lang } = Astro.props;

const navLinks = [
  { href: '#features', label: t.nav.features },
  { href: '#how-it-works', label: t.nav.howItWorks },
  { href: '#pricing', label: t.nav.pricing },
  { href: '#faq', label: t.nav.faq },
  { href: getPathWithLang('/blog/', lang), label: t.nav.blog },
];

// Language options for switcher - ONLY fr-FR, en, es (NO Morocco flag)
// Morocco flag is for geo/pricing badges, NOT for language selector
const selectorLanguages: Language[] = ['fr-FR', 'en', 'es'];
const langOptions = selectorLanguages.map((code) => ({
  code,
  flag: languageMetadata[code].flag,
  // Usar nombre traducido seg√∫n el idioma actual (normalize fr to fr-FR for translations)
  displayName: translatedLanguageNames[lang === 'fr' ? 'fr-FR' : lang][code],
  href: getPathWithLang('/', code),
  // fr and fr-FR are both French variants
  active: code === lang || (code === 'fr-FR' && lang === 'fr'),
}));

// Current language metadata for the button (normalize fr to fr-FR for display)
const currentLangMeta = languageMetadata[lang === 'fr' ? 'fr-FR' : lang];
const currentDisplayName = translatedLanguageNames[lang === 'fr' ? 'fr-FR' : lang][lang === 'fr' ? 'fr-FR' : lang];
---

<header class="fixed top-0 left-0 right-0 z-50 glass border-b border-dark-border">
  <nav class="section-container py-4">
    <div class="flex items-center justify-between">
      <!-- Logo -->
      <a href={getPathWithLang('/', lang)} class="flex items-center gap-2">
        <Logo class="h-10 w-10" />
        <span class="font-bold text-xl gradient-text">LOWIS</span>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center gap-8">
        {navLinks.map((link) => (
          <a
            href={link.href}
            class="text-text-secondary hover:text-white transition-colors duration-200 text-sm font-medium"
          >
            {link.label}
          </a>
        ))}
      </div>

      <!-- Right side: Language + Login + CTA + Menu -->
      <div class="flex items-center gap-2 sm:gap-3">
        <!-- Language Switcher -->
        <div class="relative group">
          <button
            class="flex items-center gap-1 text-text-secondary hover:text-white transition-colors px-2 py-1.5 rounded-lg hover:bg-dark-hover"
            aria-label="Change language"
          >
            <span class="text-base">{currentLangMeta.flag}</span>
            <!-- Only show name on larger screens -->
            <span class="hidden lg:inline text-sm font-medium">{currentDisplayName}</span>
            <span class="material-symbols-outlined text-base">expand_more</span>
          </button>

          <!-- Dropdown -->
          <div class="absolute right-0 top-full mt-2 py-2 bg-dark-surface border border-dark-border rounded-xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 min-w-[160px]">
            {langOptions.map((option) => (
              <a
                href={option.href}
                data-lang-choice={option.code}
                class:list={[
                  'lang-choice-link flex items-center gap-2 px-3 py-2 text-sm transition-colors',
                  option.active
                    ? 'text-primary-orange bg-dark-hover'
                    : 'text-text-secondary hover:text-white hover:bg-dark-hover',
                ]}
              >
                <span class="text-base">{option.flag}</span>
                <span>{option.displayName}</span>
                {option.active && <span class="material-symbols-outlined text-sm ml-auto">check</span>}
              </a>
            ))}
          </div>
        </div>

        <!-- Login Button - Icon only on mobile, with text on desktop -->
        <a
          href={getLoginUrlWithLang(lang)}
          class="inline-flex items-center justify-center gap-1.5 text-sm font-medium text-text-secondary hover:text-white transition-colors p-2 rounded-lg hover:bg-dark-hover"
          title={t.nav.login}
        >
          <span class="material-symbols-outlined text-xl">login</span>
          <span class="hidden lg:inline">{t.nav.login}</span>
        </a>

        <!-- CTA Button - Hidden on mobile -->
        <a href={getSignupUrlWithLang(lang)} class="btn-primary hidden md:inline-flex text-sm px-4 py-2">
          {t.nav.cta}
        </a>

        <!-- Mobile menu button -->
        <button
          id="mobile-menu-btn"
          class="md:hidden p-1.5 text-text-secondary hover:text-white transition-colors rounded-lg hover:bg-dark-hover"
          aria-label="Toggle menu"
        >
          <span class="material-symbols-outlined text-2xl" id="menu-icon">menu</span>
        </button>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-menu" class="hidden md:hidden mt-4 pt-4 border-t border-dark-border">
      <div class="flex flex-col gap-4">
        {navLinks.map((link) => (
          <a
            href={link.href}
            class="text-text-secondary hover:text-white transition-colors py-2 text-lg"
          >
            {link.label}
          </a>
        ))}
        <!-- Mobile Login Button -->
        <a
          href={getLoginUrlWithLang(lang)}
          class="flex items-center justify-center gap-2 py-3 text-text-secondary hover:text-white transition-colors border border-dark-border rounded-xl"
        >
          <span class="material-symbols-outlined">login</span>
          {t.nav.login}
        </a>

        <a href={getSignupUrlWithLang(lang)} class="btn-primary text-center mt-2">
          {t.nav.cta}
        </a>
      </div>
    </div>
  </nav>
</header>

<script>
  const menuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuIcon = document.getElementById('menu-icon');
  const header = document.querySelector('header');

  // Helper function to close the mobile menu
  function closeMobileMenu() {
    if (mobileMenu && menuIcon && !mobileMenu.classList.contains('hidden')) {
      mobileMenu.classList.add('hidden');
      menuIcon.textContent = 'menu';
    }
  }

  if (menuBtn && mobileMenu && menuIcon) {
    // Toggle menu on button click
    menuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isHidden = mobileMenu.classList.contains('hidden');
      mobileMenu.classList.toggle('hidden');
      menuIcon.textContent = isHidden ? 'close' : 'menu';
    });

    // Close menu when clicking a link
    mobileMenu.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', () => {
        closeMobileMenu();
      });
    });

    // Close menu on scroll
    let lastScrollY = window.scrollY;
    window.addEventListener('scroll', () => {
      // Close if scrolled more than 50px in any direction
      if (Math.abs(window.scrollY - lastScrollY) > 50) {
        closeMobileMenu();
        lastScrollY = window.scrollY;
      }
    }, { passive: true });

    // Close menu when clicking outside the header
    document.addEventListener('click', (e) => {
      const target = e.target as Node;
      if (header && !header.contains(target)) {
        closeMobileMenu();
      }
    });

    // Close menu on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeMobileMenu();
      }
    });
  }

  // Marcar cuando el usuario elige manualmente un idioma
  document.querySelectorAll('.lang-choice-link').forEach((link) => {
    link.addEventListener('click', () => {
      const chosenLang = link.getAttribute('data-lang-choice');
      if (chosenLang) {
        localStorage.setItem('lowis_lang_chosen', chosenLang);
      }
    });
  });
</script>
