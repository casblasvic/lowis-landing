---
import { type Language, languages, languageMetadata, getPathWithLang, defaultLang, translatedLanguageNames } from '../i18n';
import Logo from './ui/Logo.astro';
import { getSignupUrlWithLang, getLoginUrlWithLang } from '../config';

interface Props {
  t: {
    nav: {
      features: string;
      howItWorks: string;
      pricing: string;
      faq: string;
      cta: string;
      login: string;
    };
  };
  lang: Language;
}

const { t, lang } = Astro.props;

const navLinks = [
  { href: '#features', label: t.nav.features },
  { href: '#how-it-works', label: t.nav.howItWorks },
  { href: '#pricing', label: t.nav.pricing },
  { href: '#faq', label: t.nav.faq },
];

// Language options for switcher - nombres traducidos según idioma actual
const langOptions = Object.entries(languageMetadata).map(([code, meta]) => ({
  code,
  flag: meta.flag,
  region: meta.region,
  // Usar nombre traducido según el idioma actual
  displayName: translatedLanguageNames[lang][code as Language],
  href: getPathWithLang('/', code as Language),
  active: code === lang,
}));

// Current language metadata for the button
const currentLangMeta = languageMetadata[lang];
const currentDisplayName = translatedLanguageNames[lang][lang];
---

<header class="fixed top-0 left-0 right-0 z-50 glass border-b border-dark-border">
  <nav class="section-container py-4">
    <div class="flex items-center justify-between">
      <!-- Logo -->
      <a href={getPathWithLang('/', lang)} class="flex items-center gap-2">
        <Logo class="h-10 w-10" />
        <span class="font-bold text-xl gradient-text">LOWIS</span>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center gap-8">
        {navLinks.map((link) => (
          <a
            href={link.href}
            class="text-text-secondary hover:text-white transition-colors duration-200 text-sm font-medium"
          >
            {link.label}
          </a>
        ))}
      </div>

      <!-- Right side: Language + CTA -->
      <div class="flex items-center gap-4">
        <!-- Language Switcher -->
        <div class="relative group">
          <button
            class="flex items-center gap-1.5 text-text-secondary hover:text-white transition-colors px-2 py-1.5 rounded-lg hover:bg-dark-hover"
            aria-label="Change language"
          >
            <!-- Mobile: solo bandera -->
            <span class="sm:hidden text-lg">{currentLangMeta.flag}</span>
            <!-- Desktop: bandera + nombre completo -->
            <span class="hidden sm:flex items-center gap-1.5">
              <span class="text-base">{currentLangMeta.flag}</span>
              <span class="text-sm font-medium">{currentDisplayName}</span>
            </span>
            <span class="material-symbols-outlined text-lg">expand_more</span>
          </button>

          <!-- Dropdown - opciones se filtran por JS según país detectado -->
          <div class="absolute right-0 top-full mt-2 py-2 bg-dark-surface border border-dark-border rounded-xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 min-w-[200px]">
            {langOptions.map((option) => (
              <a
                href={option.href}
                data-lang-choice={option.code}
                data-lang-region={option.region}
                class:list={[
                  'lang-choice-link flex items-center gap-2 px-4 py-2.5 text-sm transition-colors',
                  option.active
                    ? 'text-primary-orange bg-dark-hover'
                    : 'text-text-secondary hover:text-white hover:bg-dark-hover',
                ]}
              >
                <span class="text-base">{option.flag}</span>
                <span>{option.displayName}</span>
                {option.active && <span class="material-symbols-outlined text-sm ml-auto">check</span>}
              </a>
            ))}
          </div>
        </div>

        <!-- Login Button -->
        <a
          href={getLoginUrlWithLang(lang)}
          class="hidden sm:inline-flex items-center gap-1.5 text-sm font-medium text-text-secondary hover:text-white transition-colors px-3 py-2"
        >
          <span class="material-symbols-outlined text-lg">login</span>
          {t.nav.login}
        </a>

        <!-- CTA Button -->
        <a href={getSignupUrlWithLang(lang)} class="btn-primary hidden sm:inline-flex text-sm px-4 py-2">
          {t.nav.cta}
        </a>

        <!-- Mobile menu button -->
        <button
          id="mobile-menu-btn"
          class="md:hidden p-2 text-text-secondary hover:text-white transition-colors"
          aria-label="Toggle menu"
        >
          <span class="material-symbols-outlined text-2xl" id="menu-icon">menu</span>
        </button>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-menu" class="hidden md:hidden mt-4 pt-4 border-t border-dark-border">
      <div class="flex flex-col gap-4">
        {navLinks.map((link) => (
          <a
            href={link.href}
            class="text-text-secondary hover:text-white transition-colors py-2 text-lg"
          >
            {link.label}
          </a>
        ))}
        <!-- Mobile Login Button -->
        <a
          href={getLoginUrlWithLang(lang)}
          class="flex items-center justify-center gap-2 py-3 text-text-secondary hover:text-white transition-colors border border-dark-border rounded-xl"
        >
          <span class="material-symbols-outlined">login</span>
          {t.nav.login}
        </a>

        <a href={getSignupUrlWithLang(lang)} class="btn-primary text-center mt-2">
          {t.nav.cta}
        </a>
      </div>
    </div>
  </nav>
</header>

<script>
  const menuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuIcon = document.getElementById('menu-icon');

  if (menuBtn && mobileMenu && menuIcon) {
    menuBtn.addEventListener('click', () => {
      const isHidden = mobileMenu.classList.contains('hidden');
      mobileMenu.classList.toggle('hidden');
      menuIcon.textContent = isHidden ? 'close' : 'menu';
    });

    // Close menu when clicking a link
    mobileMenu.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', () => {
        mobileMenu.classList.add('hidden');
        menuIcon.textContent = 'menu';
      });
    });
  }

  // CRÍTICO: Filtrar opciones de idioma según país detectado
  // Esto previene que usuarios de Marruecos vean precios de Francia y viceversa
  function filterLanguageOptions() {
    const detectedCountry = localStorage.getItem('lowis_country');
    if (!detectedCountry) return; // Si no hay detección, mostrar todo

    // Determinar región del usuario
    const moroccoGroup = ['MA', 'DZ', 'TN'];
    const franceGroup = ['FR'];

    let userRegion: 'MA' | 'FR' | 'INT';
    if (moroccoGroup.includes(detectedCountry)) {
      userRegion = 'MA';
    } else if (franceGroup.includes(detectedCountry)) {
      userRegion = 'FR';
    } else {
      userRegion = 'INT';
    }

    // Filtrar opciones del selector
    document.querySelectorAll('.lang-choice-link').forEach((link) => {
      const langRegion = link.getAttribute('data-lang-region');
      const element = link as HTMLElement;

      // Lógica de visibilidad:
      // - MA users: ver MA + INT, ocultar FR
      // - FR users: ver FR + INT, ocultar MA
      // - INT users: ver INT + el francés de su idioma actual
      if (userRegion === 'MA' && langRegion === 'FR') {
        element.style.display = 'none';
      } else if (userRegion === 'FR' && langRegion === 'MA') {
        element.style.display = 'none';
      } else {
        element.style.display = '';
      }
    });
  }

  // Ejecutar filtrado cuando la página carga
  filterLanguageOptions();

  // También ejecutar después de que GeoBanner detecte el país
  window.addEventListener('lowis-country-detected', filterLanguageOptions);

  // Marcar cuando el usuario elige manualmente un idioma
  document.querySelectorAll('.lang-choice-link').forEach((link) => {
    link.addEventListener('click', () => {
      const chosenLang = link.getAttribute('data-lang-choice');
      if (chosenLang) {
        localStorage.setItem('lowis_lang_chosen', chosenLang);
      }
    });
  });
</script>
