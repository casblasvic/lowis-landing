---
/**
 * FabianBanner.astro - Modal centrado tipo "oferta" para el agente de voz Fabian
 *
 * Modal clásico centrado con overlay, preguntas provocativas y una flecha
 * hand-drawn que apunta hacia el widget de ElevenLabs (esquina inferior derecha).
 *
 * - Aparece tras scroll 35%
 * - Se cierra con X o click en overlay
 * - No vuelve a aparecer en la sesión
 */

interface Props {
  translations: {
    title: string;
    subtitle: string;
    questions: string[];
    cta: string;
    collapsed: string;
  };
}

const { translations } = Astro.props;
---

<!-- Overlay oscuro -->
<div id="fabian-overlay" class="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300"></div>

<!-- Modal centrado -->
<div id="fabian-modal" class="fixed inset-0 z-[61] hidden items-center justify-center p-4 pointer-events-none">
  <div id="fabian-modal-content" class="relative bg-dark-surface border border-dark-border rounded-2xl shadow-2xl w-full max-w-sm pointer-events-auto opacity-0 scale-95 transition-all duration-300">

    <!-- Botón cerrar -->
    <button id="fabian-close" class="absolute top-3 right-3 p-1.5 text-text-secondary hover:text-white transition-colors rounded-full hover:bg-white/10 z-10">
      <span class="material-symbols-outlined text-xl">close</span>
    </button>

    <!-- Contenido -->
    <div class="p-6">
      <!-- Header con indicador online -->
      <div class="flex items-center gap-2.5 mb-1">
        <span class="relative flex h-3 w-3">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
        </span>
        <h3 class="text-lg font-bold text-white">{translations.title}</h3>
      </div>

      <p class="text-sm text-text-secondary mb-5 ml-[22px]">{translations.subtitle}</p>

      <!-- Preguntas -->
      <ul class="space-y-3 mb-5">
        {translations.questions.map((question) => (
          <li class="fabian-q flex items-start gap-3 p-3 rounded-xl bg-white/5 border border-white/10 cursor-pointer hover:border-primary-orange/40 hover:bg-primary-orange/5 transition-all group">
            <span class="material-symbols-outlined text-primary-orange text-xl mt-0.5 flex-shrink-0 group-hover:scale-110 transition-transform">chat_bubble</span>
            <span class="text-sm text-white/90 leading-relaxed group-hover:text-white transition-colors">{question}</span>
          </li>
        ))}
      </ul>
    </div>

    <!-- Flecha que sale del modal apuntando a esquina inferior derecha -->
    <div class="fabian-arrow-wrap absolute -bottom-16 -right-4 sm:right-2 w-20 h-16 pointer-events-none">
      <svg class="w-full h-full text-primary-orange" viewBox="0 0 80 60" fill="none">
        <path
          d="M10,5 C20,3 30,8 40,18 S60,45 72,52"
          stroke="currentColor"
          stroke-width="2.5"
          stroke-linecap="round"
          stroke-dasharray="5 4"
          class="arrow-path"
        />
        <polygon points="66,46 76,56 64,54" fill="currentColor" class="arrow-tip" />
      </svg>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = 'lowis_fabian_dismissed';
  const SCROLL_THRESHOLD = 0.35;

  function initFabianModal() {
    const overlay = document.getElementById('fabian-overlay');
    const modal = document.getElementById('fabian-modal');
    const content = document.getElementById('fabian-modal-content');
    const closeBtn = document.getElementById('fabian-close');
    const questions = document.querySelectorAll('.fabian-q');

    if (!overlay || !modal || !content) return;

    // Si ya lo cerró, no mostrar
    if (sessionStorage.getItem(STORAGE_KEY)) return;

    let shown = false;

    function showModal() {
      if (shown) return;
      shown = true;

      overlay.classList.remove('hidden');
      modal.classList.remove('hidden');
      modal.classList.add('flex');

      // Trigger animation
      requestAnimationFrame(() => {
        overlay.style.opacity = '1';
        content.style.opacity = '1';
        content.style.transform = 'scale(1)';
      });
    }

    function closeModal() {
      overlay.style.opacity = '0';
      content.style.opacity = '0';
      content.style.transform = 'scale(0.95)';

      sessionStorage.setItem(STORAGE_KEY, '1');

      setTimeout(() => {
        overlay.classList.add('hidden');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }, 300);
    }

    function activateWidget() {
      const widget = document.querySelector('elevenlabs-convai') as HTMLElement;
      if (widget) {
        widget.click();
        if (widget.shadowRoot) {
          const btn = widget.shadowRoot.querySelector('button');
          if (btn) btn.click();
        }
      }
    }

    // Cerrar
    closeBtn?.addEventListener('click', closeModal);
    overlay.addEventListener('click', closeModal);

    // Click en pregunta → activa widget y cierra
    questions.forEach(q => {
      q.addEventListener('click', () => {
        closeModal();
        // Pequeño delay para que el modal cierre antes
        setTimeout(activateWidget, 350);
      });
    });

    // Scroll trigger
    let ticking = false;
    function handleScroll() {
      if (shown) return;
      const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
      if (scrollHeight > 0 && (window.scrollY / scrollHeight) >= SCROLL_THRESHOLD) {
        showModal();
      }
    }

    window.addEventListener('scroll', () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          handleScroll();
          ticking = false;
        });
        ticking = true;
      }
    }, { passive: true });

    // Si ya scrolleó al cargar
    handleScroll();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFabianModal);
  } else {
    initFabianModal();
  }
</script>

<style>
  /* Flecha: animación de dibujo */
  .arrow-path {
    stroke-dashoffset: 80;
    animation: drawPath 1.2s ease-out 0.4s forwards;
  }

  .arrow-tip {
    opacity: 0;
    animation: showTip 0.2s ease-out 1.5s forwards;
  }

  @keyframes drawPath {
    to { stroke-dashoffset: 0; }
  }

  @keyframes showTip {
    to { opacity: 1; }
  }

  /* Bounce suave de la flecha */
  .fabian-arrow-wrap {
    animation: arrowBounce 1.8s ease-in-out infinite;
    animation-delay: 2s;
  }

  @keyframes arrowBounce {
    0%, 100% { transform: translate(0, 0); }
    50% { transform: translate(4px, 4px); }
  }
</style>
