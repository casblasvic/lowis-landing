---
import { getSignupUrlWithLang } from '../config';
import type { Language } from '../i18n';

interface Props {
  t: {
    moroccanFeatures: {
      badge?: string;
      badgeGeneric?: string;
      title: string;
      titleGeneric?: string;
      subtitle: string;
      subtitleGeneric?: string;
      items: Array<{
        icon: string;
        title: string;
        description: string;
      }>;
      recipesTitle?: string;
      recipesTitleGeneric?: string;
      recipesButton?: string;
      recipesButtonGeneric?: string;
    };
  };
  lang: Language;
}

const { t, lang } = Astro.props;

// Helper to get recipe name based on current language
function getRecipeName(recipe: { nameEn: string; nameFr: string; nameEs: string }, currentLang: Language): string {
  if (currentLang === 'es') return recipe.nameEs;
  if (currentLang === 'en') return recipe.nameEn;
  return recipe.nameFr;
}

// ============================================================================
// RECETAS - im√°genes locales optimizadas WebP (200x200)
// ============================================================================

// Moroccan recipes - im√°genes espec√≠ficas de comida marroqu√≠
const moroccanRecipes = [
  {
    nameEn: 'Chicken Tajine',
    nameFr: 'Tajine de poulet',
    nameEs: 'Tajine de pollo',
    image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/2c/Tajine_of_chicken.jpg/440px-Tajine_of_chicken.jpg',
    calories: 420
  },
  {
    nameEn: 'Royal Couscous',
    nameFr: 'Couscous royal',
    nameEs: 'Cusc√∫s real',
    image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/8a/Couscous-1.jpg/440px-Couscous-1.jpg',
    calories: 480
  },
  {
    nameEn: 'Moroccan Pastilla',
    nameFr: 'Pastilla marocaine',
    nameEs: 'Pastela marroqu√≠',
    image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/04/Bastilla.jpg/440px-Bastilla.jpg',
    calories: 450
  },
  {
    nameEn: 'Harira Soup',
    nameFr: 'Soupe Harira',
    nameEs: 'Sopa Harira',
    image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/59/Harira_soup.jpg/440px-Harira_soup.jpg',
    calories: 280
  },
  {
    nameEn: 'Moroccan Salad',
    nameFr: 'Salade marocaine',
    nameEs: 'Ensalada marroqu√≠',
    image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/94/Moroccan_salad.jpg/440px-Moroccan_salad.jpg',
    calories: 180
  },
  {
    nameEn: 'Lamb Tajine',
    nameFr: 'Tajine d\'agneau',
    nameEs: 'Tajine de cordero',
    image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/f/f5/Tajine_in_Fes.jpg/440px-Tajine_in_Fes.jpg',
    calories: 520
  }
];

// International recipes - im√°genes locales WebP optimizadas
const internationalRecipes = [
  {
    nameEn: 'Chicken Caesar Salad',
    nameFr: 'Salade C√©sar au poulet',
    nameEs: 'Ensalada C√©sar con pollo',
    image: '/images/recipes/caesar-salad.webp',
    calories: 320
  },
  {
    nameEn: 'Baked Salmon with Lemon',
    nameFr: 'Saumon au four au citron',
    nameEs: 'Salm√≥n al horno con lim√≥n',
    image: '/images/recipes/salmon-lemon.webp',
    calories: 350
  },
  {
    nameEn: 'Quinoa Vegetable Bowl',
    nameFr: 'Bowl de quinoa aux l√©gumes',
    nameEs: 'Bowl de quinoa y vegetales',
    image: '/images/recipes/quinoa-bowl.webp',
    calories: 420
  },
  {
    nameEn: 'Tofu Teriyaki with Rice',
    nameFr: 'Tofu teriyaki avec riz',
    nameEs: 'Tofu teriyaki con arroz',
    image: '/images/recipes/tofu-teriyaki.webp',
    calories: 380
  },
  {
    nameEn: 'Green Detox Smoothie',
    nameFr: 'Smoothie vert d√©tox',
    nameEs: 'Smoothie verde detox',
    image: '/images/recipes/green-smoothie.webp',
    calories: 180
  },
  {
    nameEn: 'A√ßa√≠ Bowl with Granola',
    nameFr: 'Bol d\'a√ßa√≠ avec granola',
    nameEs: 'Taz√≥n de a√ßa√≠ con granola',
    image: '/images/recipes/acai-bowl.webp',
    calories: 320
  }
];
---

<section id="moroccan" class="py-12 md:py-16 relative overflow-hidden">
  <!-- Background with Moroccan-inspired pattern -->
  <div class="absolute inset-0">
    <div class="absolute inset-0 bg-gradient-to-br from-primary-orange/5 via-dark-bg to-primary-red/5"></div>
    <div class="absolute inset-0 opacity-5" style="background-image: url(\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0L60 30L30 60L0 30z' fill='none' stroke='%23F97316' stroke-width='1'/%3E%3C/svg%3E\"); background-size: 60px 60px;"></div>
  </div>

  <div class="section-container relative z-10">
    <!-- Section header -->
    <div class="text-center max-w-3xl mx-auto mb-16">
      <!-- Badge container with fixed height to prevent CLS -->
      <div class="relative h-10 mb-6">
        <!-- Generic badge - visible by default -->
        <div data-generic-only class="inline-flex items-center gap-2 px-4 py-2 bg-primary-orange/10 border border-primary-orange/20 rounded-full absolute left-1/2 -translate-x-1/2 transition-opacity duration-200">
          <span class="material-symbols-outlined text-primary-orange">restaurant</span>
          <span class="text-primary-orange font-medium">{t.moroccanFeatures.badgeGeneric || '2000+ recipes'}</span>
        </div>
        <!-- Morocco badge - hidden by default -->
        <div data-morocco-only class="inline-flex items-center gap-2 px-4 py-2 bg-green-500/10 border border-green-500/20 rounded-full absolute left-1/2 -translate-x-1/2 opacity-0 invisible transition-opacity duration-200">
          <span class="text-2xl">üá≤üá¶</span>
          <span class="text-green-400 font-medium">{t.moroccanFeatures.badge || 'Made for Morocco'}</span>
        </div>
      </div>

      <!-- Title container with grid stacking to prevent CLS -->
      <div class="grid mb-4" style="grid-template-areas: 'title';">
        <h2 data-generic-only class="text-3xl sm:text-4xl lg:text-5xl font-bold transition-opacity duration-200" style="grid-area: title;">
          {t.moroccanFeatures.titleGeneric || 'Plus de 2000 recettes analys√©es'}
        </h2>
        <h2 data-morocco-only class="text-3xl sm:text-4xl lg:text-5xl font-bold opacity-0 invisible transition-opacity duration-200" style="grid-area: title;">
          {t.moroccanFeatures.title}
        </h2>
      </div>

      <!-- Subtitle container with grid stacking to prevent CLS -->
      <div class="grid" style="grid-template-areas: 'subtitle';">
        <p data-generic-only class="text-text-secondary text-lg transition-opacity duration-200" style="grid-area: subtitle;">
          {t.moroccanFeatures.subtitleGeneric || 'Chaque plat analys√© avec pr√©cision nutritionnelle'}
        </p>
        <p data-morocco-only class="text-text-secondary text-lg opacity-0 invisible transition-opacity duration-200" style="grid-area: subtitle;">
          {t.moroccanFeatures.subtitle}
        </p>
      </div>
    </div>

    <!-- Recipe Carousel -->
    <div class="mb-8">
      <!-- Recipe title with grid stacking to prevent CLS -->
      <div class="grid mb-6" style="grid-template-areas: 'title';">
        <p data-generic-only class="text-center text-text-muted text-sm transition-opacity duration-200" style="grid-area: title;">{t.moroccanFeatures.recipesTitleGeneric || 'D√©couvrez nos recettes analys√©es'}</p>
        <p data-morocco-only class="text-center text-text-muted text-sm opacity-0 invisible transition-opacity duration-200" style="grid-area: title;">{t.moroccanFeatures.recipesTitle || 'D√©couvrez nos recettes marocaines'}</p>
      </div>

      <!-- Carousel container with grid stacking to prevent CLS -->
      <div class="grid" style="grid-template-areas: 'carousel';">
        <!-- Generic/International carousel - visible by default -->
        <div data-generic-only class="recipe-carousel-container transition-opacity duration-200" style="grid-area: carousel;">
          <div class="recipe-carousel">
            {internationalRecipes.map((recipe) => (
              <div class="recipe-slide">
                <div class="recipe-card-img">
                  <img
                    src={recipe.image}
                    alt={getRecipeName(recipe, lang)}
                    width="200"
                    height="200"
                    loading="lazy"
                  />
                  <div class="recipe-overlay">
                    <span class="recipe-name">{getRecipeName(recipe, lang)}</span>
                    <span class="recipe-cal">{recipe.calories} kcal</span>
                  </div>
                </div>
              </div>
            ))}
            <!-- Duplicate for infinite scroll effect -->
            {internationalRecipes.map((recipe) => (
              <div class="recipe-slide">
                <div class="recipe-card-img">
                  <img
                    src={recipe.image}
                    alt={getRecipeName(recipe, lang)}
                    width="200"
                    height="200"
                    loading="lazy"
                  />
                  <div class="recipe-overlay">
                    <span class="recipe-name">{getRecipeName(recipe, lang)}</span>
                    <span class="recipe-cal">{recipe.calories} kcal</span>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        <!-- Moroccan carousel - hidden by default -->
        <div data-morocco-only class="recipe-carousel-container opacity-0 invisible transition-opacity duration-200" style="grid-area: carousel;">
          <div class="recipe-carousel">
            {moroccanRecipes.map((recipe) => (
              <div class="recipe-slide">
                <div class="recipe-card-img">
                  <img
                    src={recipe.image}
                    alt={getRecipeName(recipe, lang)}
                    width="200"
                    height="200"
                    loading="lazy"
                  />
                  <div class="recipe-overlay">
                    <span class="recipe-name">{getRecipeName(recipe, lang)}</span>
                    <span class="recipe-cal">{recipe.calories} kcal</span>
                  </div>
                </div>
              </div>
            ))}
            <!-- Duplicate for infinite scroll effect -->
            {moroccanRecipes.map((recipe) => (
              <div class="recipe-slide">
                <div class="recipe-card-img">
                  <img
                    src={recipe.image}
                    alt={getRecipeName(recipe, lang)}
                    width="200"
                    height="200"
                    loading="lazy"
                  />
                  <div class="recipe-overlay">
                    <span class="recipe-name">{getRecipeName(recipe, lang)}</span>
                    <span class="recipe-cal">{recipe.calories} kcal</span>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      <!-- Button container with grid stacking to prevent CLS -->
      <div class="grid justify-center mt-6" style="grid-template-areas: 'button';">
        <!-- Generic button - visible by default -->
        <a
          data-generic-only
          href={getSignupUrlWithLang(lang)}
          class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-primary-orange to-primary-red text-white font-semibold rounded-full hover:shadow-lg hover:shadow-primary-orange/30 transition-all duration-300 hover:scale-105"
          style="grid-area: button;"
        >
          <span class="material-symbols-outlined">restaurant</span>
          {t.moroccanFeatures.recipesButtonGeneric || 'Voir +2000 recettes analys√©es'}
        </a>
        <!-- Morocco button - hidden by default -->
        <a
          data-morocco-only
          href={getSignupUrlWithLang(lang)}
          class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-primary-orange to-primary-red text-white font-semibold rounded-full hover:shadow-lg hover:shadow-primary-orange/30 transition-all duration-300 hover:scale-105 opacity-0 invisible"
          style="grid-area: button;"
        >
          <span class="material-symbols-outlined">restaurant</span>
          {t.moroccanFeatures.recipesButton || 'Voir +500 recettes marocaines'}
        </a>
      </div>
    </div>

  </div>
</section>

<style>
  .recipe-carousel-container {
    width: 100%;
    overflow: hidden;
    mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
    -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
    touch-action: pan-x;
    cursor: grab;
  }

  .recipe-carousel-container:active {
    cursor: grabbing;
  }

  .recipe-carousel {
    display: flex;
    gap: 1rem;
    animation: scroll 30s linear infinite;
    will-change: transform;
  }

  .recipe-carousel:hover {
    animation-play-state: paused;
  }

  .recipe-carousel.dragging {
    animation: none;
    transition: none;
  }

  @keyframes scroll {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }

  .recipe-slide {
    flex-shrink: 0;
  }

  .recipe-card-img {
    position: relative;
    width: 200px;
    height: 200px;
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    border: 2px solid transparent;
    transition: all 0.3s ease;
  }

  .recipe-card-img:hover {
    border-color: #F97316;
    transform: scale(1.05);
  }

  .recipe-card-img img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
    aspect-ratio: 1 / 1;
  }

  .recipe-card-img:hover img {
    transform: scale(1.1);
  }

  .recipe-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1rem;
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .recipe-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: white;
    line-height: 1.2;
  }

  .recipe-cal {
    font-size: 0.75rem;
    color: #F97316;
    font-weight: 500;
  }

  @media (max-width: 640px) {
    .recipe-card-img {
      width: 150px;
      height: 150px;
    }

    .recipe-name {
      font-size: 0.75rem;
    }

    .recipe-cal {
      font-size: 0.65rem;
    }
  }
</style>

<script>
  // Touch/swipe support for recipe carousels (optimized to avoid forced reflows)
  document.querySelectorAll('.recipe-carousel-container').forEach(container => {
    const carousel = container.querySelector('.recipe-carousel') as HTMLElement | null;

    if (!carousel) return;

    let isDragging = false;
    let startX = 0;
    let currentTranslate = 0;
    let prevTranslate = 0;
    let cachedWidth = 0;
    let animationStartTime = 0;
    const ANIMATION_DURATION = 30000; // 30 seconds in ms

    // Cache carousel width once on first interaction (avoids repeated reflows)
    function getCarouselWidth(): number {
      if (cachedWidth === 0) {
        cachedWidth = carousel!.scrollWidth / 2;
      }
      return cachedWidth;
    }

    // Calculate current position mathematically (NO getComputedStyle = NO forced reflow)
    function calculateCurrentPosition(): number {
      if (animationStartTime === 0) {
        // First interaction - start tracking from now
        animationStartTime = performance.now();
        return 0;
      }
      const elapsed = performance.now() - animationStartTime;
      const width = getCarouselWidth();
      // Animation goes from 0 to -width over ANIMATION_DURATION, then loops
      const progress = (elapsed % ANIMATION_DURATION) / ANIMATION_DURATION;
      return -width * progress;
    }

    // Resume animation from current position
    function resumeAnimation() {
      const width = getCarouselWidth();
      const progress = Math.abs(currentTranslate) / width;
      const remainingDuration = 30 * (1 - progress);

      // Update animation start time to match current position
      animationStartTime = performance.now() - (progress * ANIMATION_DURATION);

      carousel!.style.animation = 'none';
      carousel!.style.transform = `translateX(${currentTranslate}px)`;
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          carousel!.style.animation = `scroll ${remainingDuration}s linear infinite`;
        });
      });
    }

    // Handle drag movement (shared logic)
    function handleDragMove(clientX: number) {
      if (!isDragging) return;
      const diff = clientX - startX;
      currentTranslate = prevTranslate + diff;

      const width = getCarouselWidth();

      // Wrap around for infinite feel
      if (currentTranslate > 0) {
        currentTranslate = -width + currentTranslate;
        prevTranslate = currentTranslate - diff;
      } else if (currentTranslate < -width) {
        currentTranslate = currentTranslate + width;
        prevTranslate = currentTranslate - diff;
      }

      carousel!.style.transform = `translateX(${currentTranslate}px)`;
    }

    // Touch events
    container.addEventListener('touchstart', (e: TouchEvent) => {
      isDragging = true;
      startX = e.touches[0].clientX;
      prevTranslate = calculateCurrentPosition();
      carousel!.classList.add('dragging');
      carousel!.style.transform = `translateX(${prevTranslate}px)`;
    }, { passive: true });

    container.addEventListener('touchmove', (e: TouchEvent) => {
      handleDragMove(e.touches[0].clientX);
    }, { passive: true });

    container.addEventListener('touchend', () => {
      isDragging = false;
      carousel!.classList.remove('dragging');
      resumeAnimation();
    });

    // Mouse events for desktop drag
    container.addEventListener('mousedown', (e: MouseEvent) => {
      isDragging = true;
      startX = e.clientX;
      prevTranslate = calculateCurrentPosition();
      carousel!.classList.add('dragging');
      carousel!.style.transform = `translateX(${prevTranslate}px)`;
      e.preventDefault();
    });

    container.addEventListener('mousemove', (e: MouseEvent) => {
      handleDragMove(e.clientX);
    });

    container.addEventListener('mouseup', () => {
      if (!isDragging) return;
      isDragging = false;
      carousel!.classList.remove('dragging');
      resumeAnimation();
    });

    container.addEventListener('mouseleave', () => {
      if (isDragging) {
        isDragging = false;
        carousel!.classList.remove('dragging');
        resumeAnimation();
      }
    });
  });
</script>
