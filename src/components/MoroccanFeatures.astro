---
interface Props {
  t: {
    moroccanFeatures: {
      title: string;
      subtitle: string;
      items: Array<{
        icon: string;
        title: string;
        description: string;
      }>;
      recipesTitle?: string;
    };
  };
}

const { t } = Astro.props;

// Real Moroccan recipes from our database with actual images
const moroccanRecipes = [
  {
    name: 'Tajine Poulet Citron',
    nameFr: 'Tajine au poulet et citron',
    image: 'https://yjxnyjcaxehosndbyepg.supabase.co/storage/v1/object/public/public_nutri_app_bucket/global/recipe-images/wordpress/2025/11/15056.jpeg',
    calories: 686
  },
  {
    name: 'Harira',
    nameFr: 'Soupe marocaine Harira',
    image: 'https://yjxnyjcaxehosndbyepg.supabase.co/storage/v1/object/public/public_nutri_app_bucket/global/recipe-images/wordpress/2025/11/28644.webp',
    calories: 180
  },
  {
    name: 'Tajine Viande LÃ©gumes',
    nameFr: 'Tajine de viande et lÃ©gumes',
    image: 'https://yjxnyjcaxehosndbyepg.supabase.co/storage/v1/object/public/public_nutri_app_bucket/global/recipe-images/wordpress/2025/11/15140.jpeg',
    calories: 689
  },
  {
    name: 'Batbout Farci',
    nameFr: 'Batbout farci Ã  la viande',
    image: 'https://yjxnyjcaxehosndbyepg.supabase.co/storage/v1/object/public/public_nutri_app_bucket/global/recipe-images/wordpress/2025/11/29167.jpeg',
    calories: 420
  },
  {
    name: 'Tajine Albondigas',
    nameFr: 'Tajine aux boulettes',
    image: 'https://yjxnyjcaxehosndbyepg.supabase.co/storage/v1/object/public/public_nutri_app_bucket/global/recipe-images/wordpress/2025/11/19778.jpeg',
    calories: 561
  },
  {
    name: 'Bakoula',
    nameFr: 'Ã‰pinards Ã  la marocaine',
    image: 'https://yjxnyjcaxehosndbyepg.supabase.co/storage/v1/object/public/public_nutri_app_bucket/global/recipe-images/wordpress/2025/11/18407.jpeg',
    calories: 145
  },
  {
    name: 'Lentejas MarroquÃ­',
    nameFr: 'Lentilles Ã  la marocaine',
    image: 'https://yjxnyjcaxehosndbyepg.supabase.co/storage/v1/object/public/public_nutri_app_bucket/global/recipe-images/wordpress/2025/11/28537.jpeg',
    calories: 280
  },
  {
    name: 'Ensalada MarroquÃ­',
    nameFr: 'Salade marocaine',
    image: 'https://yjxnyjcaxehosndbyepg.supabase.co/storage/v1/object/public/public_nutri_app_bucket/global/recipe-images/wordpress/2025/11/14378.jpeg',
    calories: 95
  },
  {
    name: 'Tajine Cardos',
    nameFr: 'Tajine aux cardons',
    image: 'https://yjxnyjcaxehosndbyepg.supabase.co/storage/v1/object/public/public_nutri_app_bucket/global/recipe-images/wordpress/2025/11/19074.jpeg',
    calories: 221
  },
  {
    name: 'Couscous Garbanzos',
    nameFr: 'Couscous aux pois chiches',
    image: 'https://yjxnyjcaxehosndbyepg.supabase.co/storage/v1/object/public/spoonacular_images/recipes/bf480f94-4219-4f21-948e-4b845099b8a9.jpg',
    calories: 714
  }
];
---

<section id="moroccan" class="py-20 relative overflow-hidden">
  <!-- Background with Moroccan-inspired pattern -->
  <div class="absolute inset-0">
    <div class="absolute inset-0 bg-gradient-to-br from-primary-orange/5 via-dark-bg to-primary-red/5"></div>
    <div class="absolute inset-0 opacity-5" style="background-image: url(\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0L60 30L30 60L0 30z' fill='none' stroke='%23F97316' stroke-width='1'/%3E%3C/svg%3E\"); background-size: 60px 60px;"></div>
  </div>

  <div class="section-container relative z-10">
    <!-- Section header -->
    <div class="text-center max-w-3xl mx-auto mb-16">
      <div class="inline-flex items-center gap-2 px-4 py-2 bg-green-500/10 border border-green-500/20 rounded-full mb-6">
        <span class="text-2xl">ðŸ‡²ðŸ‡¦</span>
        <span class="text-green-400 font-medium">Made for Morocco</span>
      </div>
      <h2 class="text-3xl sm:text-4xl lg:text-5xl font-bold mb-4">
        {t.moroccanFeatures.title}
      </h2>
      <p class="text-text-secondary text-lg">
        {t.moroccanFeatures.subtitle}
      </p>
    </div>

    <!-- Recipe Carousel -->
    <div class="mb-16">
      <p class="text-center text-text-muted text-sm mb-6">{t.moroccanFeatures.recipesTitle || 'DÃ©couvrez nos recettes marocaines'}</p>

      <div class="recipe-carousel-container">
        <div class="recipe-carousel">
          {moroccanRecipes.map((recipe) => (
            <div class="recipe-slide">
              <div class="recipe-card-img">
                <img
                  src={recipe.image}
                  alt={recipe.nameFr}
                  loading="lazy"
                />
                <div class="recipe-overlay">
                  <span class="recipe-name">{recipe.nameFr}</span>
                  <span class="recipe-cal">{recipe.calories} kcal</span>
                </div>
              </div>
            </div>
          ))}
          <!-- Duplicate for infinite scroll effect -->
          {moroccanRecipes.map((recipe) => (
            <div class="recipe-slide">
              <div class="recipe-card-img">
                <img
                  src={recipe.image}
                  alt={recipe.nameFr}
                  loading="lazy"
                />
                <div class="recipe-overlay">
                  <span class="recipe-name">{recipe.nameFr}</span>
                  <span class="recipe-cal">{recipe.calories} kcal</span>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>

    <!-- Features grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
      {t.moroccanFeatures.items.map((item) => (
        <div
          class="relative group p-8 bg-dark-surface border border-dark-border rounded-2xl overflow-hidden hover:border-green-500/50 transition-all duration-300"
        >
          <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-green-500 via-primary-orange to-primary-red opacity-0 group-hover:opacity-100 transition-opacity"></div>

          <div class="flex items-start gap-4">
            <div class="w-14 h-14 flex items-center justify-center bg-gradient-to-br from-green-500/20 to-primary-orange/20 rounded-2xl">
              <span class="material-symbols-outlined text-3xl text-green-400">{item.icon}</span>
            </div>
            <div class="flex-1">
              <h3 class="font-bold text-xl mb-3">
                {item.title}
              </h3>
              <p class="text-text-secondary leading-relaxed">
                {item.description}
              </p>
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>
</section>

<style>
  .recipe-carousel-container {
    width: 100%;
    overflow: hidden;
    mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
    -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
    touch-action: pan-x;
    cursor: grab;
  }

  .recipe-carousel-container:active {
    cursor: grabbing;
  }

  .recipe-carousel {
    display: flex;
    gap: 1rem;
    animation: scroll 30s linear infinite;
    will-change: transform;
  }

  .recipe-carousel:hover {
    animation-play-state: paused;
  }

  .recipe-carousel.dragging {
    animation: none;
    transition: none;
  }

  @keyframes scroll {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }

  .recipe-slide {
    flex-shrink: 0;
  }

  .recipe-card-img {
    position: relative;
    width: 200px;
    height: 200px;
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    border: 2px solid transparent;
    transition: all 0.3s ease;
  }

  .recipe-card-img:hover {
    border-color: #F97316;
    transform: scale(1.05);
  }

  .recipe-card-img img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .recipe-card-img:hover img {
    transform: scale(1.1);
  }

  .recipe-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1rem;
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .recipe-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: white;
    line-height: 1.2;
  }

  .recipe-cal {
    font-size: 0.75rem;
    color: #F97316;
    font-weight: 500;
  }

  @media (max-width: 640px) {
    .recipe-card-img {
      width: 150px;
      height: 150px;
    }

    .recipe-name {
      font-size: 0.75rem;
    }

    .recipe-cal {
      font-size: 0.65rem;
    }
  }
</style>

<script>
  // Touch/swipe support for recipe carousel
  const container = document.querySelector('.recipe-carousel-container');
  const carousel = document.querySelector('.recipe-carousel');

  if (container && carousel) {
    let isDragging = false;
    let startX = 0;
    let currentTranslate = 0;
    let prevTranslate = 0;
    let animationID = 0;

    // Get the current transform value from animation
    function getCurrentTransform() {
      const style = window.getComputedStyle(carousel);
      const matrix = new DOMMatrix(style.transform);
      return matrix.m41; // translateX value
    }

    // Touch events
    container.addEventListener('touchstart', (e) => {
      isDragging = true;
      startX = e.touches[0].clientX;
      prevTranslate = getCurrentTransform();
      carousel.classList.add('dragging');
      carousel.style.transform = `translateX(${prevTranslate}px)`;
    }, { passive: true });

    container.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      const currentX = e.touches[0].clientX;
      const diff = currentX - startX;
      currentTranslate = prevTranslate + diff;

      // Get carousel width for boundaries
      const carouselWidth = carousel.scrollWidth / 2;

      // Wrap around for infinite feel
      if (currentTranslate > 0) {
        currentTranslate = -carouselWidth + currentTranslate;
        prevTranslate = currentTranslate - diff;
      } else if (currentTranslate < -carouselWidth) {
        currentTranslate = currentTranslate + carouselWidth;
        prevTranslate = currentTranslate - diff;
      }

      carousel.style.transform = `translateX(${currentTranslate}px)`;
    }, { passive: true });

    container.addEventListener('touchend', () => {
      isDragging = false;
      carousel.classList.remove('dragging');

      // Resume animation from current position
      const carouselWidth = carousel.scrollWidth / 2;
      const progress = Math.abs(currentTranslate) / carouselWidth;
      const remainingDuration = 30 * (1 - progress);

      carousel.style.animation = 'none';
      carousel.offsetHeight; // Force reflow
      carousel.style.transform = `translateX(${currentTranslate}px)`;
      carousel.style.animation = `scroll ${remainingDuration}s linear infinite`;
    });

    // Mouse events for desktop drag
    container.addEventListener('mousedown', (e) => {
      isDragging = true;
      startX = e.clientX;
      prevTranslate = getCurrentTransform();
      carousel.classList.add('dragging');
      carousel.style.transform = `translateX(${prevTranslate}px)`;
      e.preventDefault();
    });

    container.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const currentX = e.clientX;
      const diff = currentX - startX;
      currentTranslate = prevTranslate + diff;

      const carouselWidth = carousel.scrollWidth / 2;

      if (currentTranslate > 0) {
        currentTranslate = -carouselWidth + currentTranslate;
        prevTranslate = currentTranslate - diff;
      } else if (currentTranslate < -carouselWidth) {
        currentTranslate = currentTranslate + carouselWidth;
        prevTranslate = currentTranslate - diff;
      }

      carousel.style.transform = `translateX(${currentTranslate}px)`;
    });

    container.addEventListener('mouseup', () => {
      if (!isDragging) return;
      isDragging = false;
      carousel.classList.remove('dragging');

      const carouselWidth = carousel.scrollWidth / 2;
      const progress = Math.abs(currentTranslate) / carouselWidth;
      const remainingDuration = 30 * (1 - progress);

      carousel.style.animation = 'none';
      carousel.offsetHeight;
      carousel.style.transform = `translateX(${currentTranslate}px)`;
      carousel.style.animation = `scroll ${remainingDuration}s linear infinite`;
    });

    container.addEventListener('mouseleave', () => {
      if (isDragging) {
        isDragging = false;
        carousel.classList.remove('dragging');

        const carouselWidth = carousel.scrollWidth / 2;
        const progress = Math.abs(currentTranslate) / carouselWidth;
        const remainingDuration = 30 * (1 - progress);

        carousel.style.animation = 'none';
        carousel.offsetHeight;
        carousel.style.transform = `translateX(${currentTranslate}px)`;
        carousel.style.animation = `scroll ${remainingDuration}s linear infinite`;
      }
    });
  }
</script>
