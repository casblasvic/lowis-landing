---
import { getSignupUrlWithLang } from '../config';
import type { Language } from '../i18n';

interface Props {
  t: {
    moroccanFeatures: {
      badge?: string;
      badgeGeneric?: string;
      title: string;
      titleGeneric?: string;
      subtitle: string;
      subtitleGeneric?: string;
      items: Array<{
        icon: string;
        title: string;
        description: string;
      }>;
      recipesTitle?: string;
      recipesTitleGeneric?: string;
      recipesButton?: string;
      recipesButtonGeneric?: string;
    };
  };
  lang: Language;
}

const { t, lang } = Astro.props;

// Helper to get recipe name based on current language
function getRecipeName(recipe: { nameEn: string; nameFr: string; nameEs: string }, currentLang: Language): string {
  if (currentLang === 'es') return recipe.nameEs;
  if (currentLang === 'en') return recipe.nameEn;
  return recipe.nameFr;
}

// ============================================================================
// RECETAS REALES del proyecto principal - im√°genes verificadas de Unsplash
// ============================================================================

// Moroccan recipes - im√°genes verificadas de Unsplash
const moroccanRecipes = [
  {
    nameEn: 'Chicken Tajine with Lemon',
    nameFr: 'Tajine de poulet au citron',
    nameEs: 'Tajine de pollo con lim√≥n',
    image: 'https://images.unsplash.com/photo-1511690743698-d9d85f2fbf38?w=400',
    calories: 420
  },
  {
    nameEn: 'Lamb Couscous',
    nameFr: 'Couscous √† l\'agneau',
    nameEs: 'Cusc√∫s con cordero',
    image: 'https://images.unsplash.com/photo-1585937421612-70a008356fbe?w=400',
    calories: 480
  },
  {
    nameEn: 'Kefta Meatballs',
    nameFr: 'Boulettes de kefta',
    nameEs: 'Alb√≥ndigas kefta',
    image: 'https://images.unsplash.com/photo-1529042410759-befb1204b468?w=400',
    calories: 350
  },
  {
    nameEn: 'Moroccan Harira Soup',
    nameFr: 'Soupe Harira marocaine',
    nameEs: 'Sopa Harira marroqu√≠',
    image: 'https://images.unsplash.com/photo-1547592166-23ac45744acd?w=400',
    calories: 280
  },
  {
    nameEn: 'Grilled Fish Chermoula',
    nameFr: 'Poisson grill√© chermoula',
    nameEs: 'Pescado a la parrilla chermoula',
    image: 'https://images.unsplash.com/photo-1519708227418-c8fd9a32b7a2?w=400',
    calories: 320
  },
  {
    nameEn: 'Vegetable Tajine',
    nameFr: 'Tajine aux l√©gumes',
    nameEs: 'Tajine de verduras',
    image: 'https://images.unsplash.com/photo-1540914124281-342587941389?w=400',
    calories: 290
  }
];

// International recipes - del seed del proyecto principal con im√°genes Unsplash verificadas
const internationalRecipes = [
  {
    nameEn: 'Chicken Caesar Salad',
    nameFr: 'Salade C√©sar au poulet',
    nameEs: 'Ensalada C√©sar con pollo',
    image: 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400',
    calories: 320
  },
  {
    nameEn: 'Baked Salmon with Lemon',
    nameFr: 'Saumon au four au citron',
    nameEs: 'Salm√≥n al horno con lim√≥n',
    image: 'https://images.unsplash.com/photo-1467003909585-2f8a72700288?w=400',
    calories: 350
  },
  {
    nameEn: 'Quinoa Vegetable Bowl',
    nameFr: 'Bowl de quinoa aux l√©gumes',
    nameEs: 'Bowl de quinoa y vegetales',
    image: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=400',
    calories: 420
  },
  {
    nameEn: 'Tofu Teriyaki with Rice',
    nameFr: 'Tofu teriyaki avec riz',
    nameEs: 'Tofu teriyaki con arroz',
    image: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?w=400',
    calories: 380
  },
  {
    nameEn: 'Green Detox Smoothie',
    nameFr: 'Smoothie vert d√©tox',
    nameEs: 'Smoothie verde detox',
    image: 'https://images.unsplash.com/photo-1610970881699-44a5587cabec?w=400',
    calories: 180
  },
  {
    nameEn: 'A√ßa√≠ Bowl with Granola',
    nameFr: 'Bol d\'a√ßa√≠ avec granola',
    nameEs: 'Taz√≥n de a√ßa√≠ con granola',
    image: 'https://images.unsplash.com/photo-1590301157890-4810ed352733?w=400',
    calories: 320
  }
];
---

<section id="moroccan" class="py-12 md:py-16 relative overflow-hidden">
  <!-- Background with Moroccan-inspired pattern -->
  <div class="absolute inset-0">
    <div class="absolute inset-0 bg-gradient-to-br from-primary-orange/5 via-dark-bg to-primary-red/5"></div>
    <div class="absolute inset-0 opacity-5" style="background-image: url(\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0L60 30L30 60L0 30z' fill='none' stroke='%23F97316' stroke-width='1'/%3E%3C/svg%3E\"); background-size: 60px 60px;"></div>
  </div>

  <div class="section-container relative z-10">
    <!-- Section header -->
    <div class="text-center max-w-3xl mx-auto mb-16">
      <!-- Generic badge - visible by default (safe for global audience) -->
      <div data-generic-only class="inline-flex items-center gap-2 px-4 py-2 bg-primary-orange/10 border border-primary-orange/20 rounded-full mb-6">
        <span class="material-symbols-outlined text-primary-orange">restaurant</span>
        <span class="text-primary-orange font-medium">{t.moroccanFeatures.badgeGeneric || '2000+ recipes'}</span>
      </div>
      <!-- Morocco badge - hidden by default, shown only for Morocco users -->
      <div data-morocco-only style="display: none" class="inline-flex items-center gap-2 px-4 py-2 bg-green-500/10 border border-green-500/20 rounded-full mb-6">
        <span class="text-2xl">üá≤üá¶</span>
        <span class="text-green-400 font-medium">{t.moroccanFeatures.badge || 'Made for Morocco'}</span>
      </div>

      <!-- Title: Generic version - visible by default -->
      <h2 data-generic-only class="text-3xl sm:text-4xl lg:text-5xl font-bold mb-4">
        {t.moroccanFeatures.titleGeneric || 'Plus de 2000 recettes analys√©es'}
      </h2>
      <!-- Title: Morocco version - hidden by default -->
      <h2 data-morocco-only style="display: none" class="text-3xl sm:text-4xl lg:text-5xl font-bold mb-4">
        {t.moroccanFeatures.title}
      </h2>

      <!-- Subtitle: Generic version - visible by default -->
      <p data-generic-only class="text-text-secondary text-lg">
        {t.moroccanFeatures.subtitleGeneric || 'Chaque plat analys√© avec pr√©cision nutritionnelle'}
      </p>
      <!-- Subtitle: Morocco version - hidden by default -->
      <p data-morocco-only style="display: none" class="text-text-secondary text-lg">
        {t.moroccanFeatures.subtitle}
      </p>
    </div>

    <!-- Recipe Carousel -->
    <div class="mb-8">
      <!-- Recipe title: Generic version - visible by default -->
      <p data-generic-only class="text-center text-text-muted text-sm mb-6">{t.moroccanFeatures.recipesTitleGeneric || 'D√©couvrez nos recettes analys√©es'}</p>
      <!-- Recipe title: Morocco version - hidden by default -->
      <p data-morocco-only style="display: none" class="text-center text-text-muted text-sm mb-6">{t.moroccanFeatures.recipesTitle || 'D√©couvrez nos recettes marocaines'}</p>

      <!-- Generic/International carousel - visible by default -->
      <div data-generic-only class="recipe-carousel-container">
        <div class="recipe-carousel">
          {internationalRecipes.map((recipe) => (
            <div class="recipe-slide">
              <div class="recipe-card-img">
                <img
                  src={recipe.image}
                  alt={getRecipeName(recipe, lang)}
                  width="200"
                  height="200"
                  loading="lazy"
                />
                <div class="recipe-overlay">
                  <span class="recipe-name">{getRecipeName(recipe, lang)}</span>
                  <span class="recipe-cal">{recipe.calories} kcal</span>
                </div>
              </div>
            </div>
          ))}
          <!-- Duplicate for infinite scroll effect -->
          {internationalRecipes.map((recipe) => (
            <div class="recipe-slide">
              <div class="recipe-card-img">
                <img
                  src={recipe.image}
                  alt={getRecipeName(recipe, lang)}
                  width="200"
                  height="200"
                  loading="lazy"
                />
                <div class="recipe-overlay">
                  <span class="recipe-name">{getRecipeName(recipe, lang)}</span>
                  <span class="recipe-cal">{recipe.calories} kcal</span>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      <!-- Moroccan carousel - hidden by default -->
      <div data-morocco-only style="display: none" class="recipe-carousel-container">
        <div class="recipe-carousel">
          {moroccanRecipes.map((recipe) => (
            <div class="recipe-slide">
              <div class="recipe-card-img">
                <img
                  src={recipe.image}
                  alt={getRecipeName(recipe, lang)}
                  width="200"
                  height="200"
                  loading="lazy"
                />
                <div class="recipe-overlay">
                  <span class="recipe-name">{getRecipeName(recipe, lang)}</span>
                  <span class="recipe-cal">{recipe.calories} kcal</span>
                </div>
              </div>
            </div>
          ))}
          <!-- Duplicate for infinite scroll effect -->
          {moroccanRecipes.map((recipe) => (
            <div class="recipe-slide">
              <div class="recipe-card-img">
                <img
                  src={recipe.image}
                  alt={getRecipeName(recipe, lang)}
                  width="200"
                  height="200"
                  loading="lazy"
                />
                <div class="recipe-overlay">
                  <span class="recipe-name">{getRecipeName(recipe, lang)}</span>
                  <span class="recipe-cal">{recipe.calories} kcal</span>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      <!-- Button to see more recipes -->
      <div class="flex justify-center mt-6">
        <!-- Generic button - visible by default -->
        <a
          data-generic-only
          href={getSignupUrlWithLang(lang)}
          class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-primary-orange to-primary-red text-white font-semibold rounded-full hover:shadow-lg hover:shadow-primary-orange/30 transition-all duration-300 hover:scale-105"
        >
          <span class="material-symbols-outlined">restaurant</span>
          {t.moroccanFeatures.recipesButtonGeneric || 'Voir +2000 recettes analys√©es'}
        </a>
        <!-- Morocco button - hidden by default -->
        <a
          data-morocco-only
          style="display: none"
          href={getSignupUrlWithLang(lang)}
          class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-primary-orange to-primary-red text-white font-semibold rounded-full hover:shadow-lg hover:shadow-primary-orange/30 transition-all duration-300 hover:scale-105"
        >
          <span class="material-symbols-outlined">restaurant</span>
          {t.moroccanFeatures.recipesButton || 'Voir +500 recettes marocaines'}
        </a>
      </div>
    </div>

  </div>
</section>

<style>
  .recipe-carousel-container {
    width: 100%;
    overflow: hidden;
    mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
    -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
    touch-action: pan-x;
    cursor: grab;
  }

  .recipe-carousel-container:active {
    cursor: grabbing;
  }

  .recipe-carousel {
    display: flex;
    gap: 1rem;
    animation: scroll 30s linear infinite;
    will-change: transform;
  }

  .recipe-carousel:hover {
    animation-play-state: paused;
  }

  .recipe-carousel.dragging {
    animation: none;
    transition: none;
  }

  @keyframes scroll {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }

  .recipe-slide {
    flex-shrink: 0;
  }

  .recipe-card-img {
    position: relative;
    width: 200px;
    height: 200px;
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    border: 2px solid transparent;
    transition: all 0.3s ease;
  }

  .recipe-card-img:hover {
    border-color: #F97316;
    transform: scale(1.05);
  }

  .recipe-card-img img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
    aspect-ratio: 1 / 1;
  }

  .recipe-card-img:hover img {
    transform: scale(1.1);
  }

  .recipe-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1rem;
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .recipe-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: white;
    line-height: 1.2;
  }

  .recipe-cal {
    font-size: 0.75rem;
    color: #F97316;
    font-weight: 500;
  }

  @media (max-width: 640px) {
    .recipe-card-img {
      width: 150px;
      height: 150px;
    }

    .recipe-name {
      font-size: 0.75rem;
    }

    .recipe-cal {
      font-size: 0.65rem;
    }
  }
</style>

<script>
  // Touch/swipe support for recipe carousels (optimized to avoid forced reflows)
  document.querySelectorAll('.recipe-carousel-container').forEach(container => {
    const carousel = container.querySelector('.recipe-carousel') as HTMLElement | null;

    if (!carousel) return;

    let isDragging = false;
    let startX = 0;
    let currentTranslate = 0;
    let prevTranslate = 0;
    let cachedWidth = 0; // Cache scrollWidth to avoid repeated layout queries

    // Cache carousel width once on first interaction (avoids repeated reflows)
    function getCarouselWidth(): number {
      if (cachedWidth === 0) {
        cachedWidth = carousel!.scrollWidth / 2;
      }
      return cachedWidth;
    }

    // Get initial transform - only called once at drag start
    function captureCurrentTransform(): number {
      const style = window.getComputedStyle(carousel!);
      const matrix = new DOMMatrix(style.transform);
      return matrix.m41;
    }

    // Resume animation helper
    function resumeAnimation() {
      const width = getCarouselWidth();
      const progress = Math.abs(currentTranslate) / width;
      const remainingDuration = 30 * (1 - progress);

      carousel!.style.animation = 'none';
      carousel!.style.transform = `translateX(${currentTranslate}px)`;
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          carousel!.style.animation = `scroll ${remainingDuration}s linear infinite`;
        });
      });
    }

    // Handle drag movement (shared logic)
    function handleDragMove(clientX: number) {
      if (!isDragging) return;
      const diff = clientX - startX;
      currentTranslate = prevTranslate + diff;

      const width = getCarouselWidth();

      // Wrap around for infinite feel
      if (currentTranslate > 0) {
        currentTranslate = -width + currentTranslate;
        prevTranslate = currentTranslate - diff;
      } else if (currentTranslate < -width) {
        currentTranslate = currentTranslate + width;
        prevTranslate = currentTranslate - diff;
      }

      carousel!.style.transform = `translateX(${currentTranslate}px)`;
    }

    // Touch events
    container.addEventListener('touchstart', (e: TouchEvent) => {
      isDragging = true;
      startX = e.touches[0].clientX;
      prevTranslate = captureCurrentTransform();
      carousel!.classList.add('dragging');
      carousel!.style.transform = `translateX(${prevTranslate}px)`;
    }, { passive: true });

    container.addEventListener('touchmove', (e: TouchEvent) => {
      handleDragMove(e.touches[0].clientX);
    }, { passive: true });

    container.addEventListener('touchend', () => {
      isDragging = false;
      carousel!.classList.remove('dragging');
      resumeAnimation();
    });

    // Mouse events for desktop drag
    container.addEventListener('mousedown', (e: MouseEvent) => {
      isDragging = true;
      startX = e.clientX;
      prevTranslate = captureCurrentTransform();
      carousel!.classList.add('dragging');
      carousel!.style.transform = `translateX(${prevTranslate}px)`;
      e.preventDefault();
    });

    container.addEventListener('mousemove', (e: MouseEvent) => {
      handleDragMove(e.clientX);
    });

    container.addEventListener('mouseup', () => {
      if (!isDragging) return;
      isDragging = false;
      carousel!.classList.remove('dragging');
      resumeAnimation();
    });

    container.addEventListener('mouseleave', () => {
      if (isDragging) {
        isDragging = false;
        carousel!.classList.remove('dragging');
        resumeAnimation();
      }
    });
  });
</script>
