---
// GeoBanner.astro - Banner de geo-detecciÃ³n con bandera del paÃ­s
---

<div id="geo-banner" class="fixed top-0 left-0 right-0 z-[100] transform -translate-y-full transition-transform duration-500 ease-out">
  <div class="bg-gradient-to-r from-primary-orange to-primary-red text-white py-3 px-4 shadow-lg">
    <div class="max-w-4xl mx-auto flex items-center justify-between gap-4">
      <!-- Left: Flag + Message -->
      <div class="flex items-center gap-3 flex-1 min-w-0">
        <span id="country-flag" class="text-2xl flex-shrink-0"></span>
        <span id="banner-message" class="text-sm font-medium truncate"></span>
      </div>

      <!-- Right: CTA + Close -->
      <div class="flex items-center gap-2 flex-shrink-0">
        <button id="banner-cta" class="bg-white text-gray-900 px-4 py-1.5 rounded-full text-sm font-bold hover:bg-gray-100 transition-colors whitespace-nowrap">
          OK
        </button>
        <button id="banner-dismiss" class="p-1 text-white/80 hover:text-white transition-colors" aria-label="Close">
          <span class="material-symbols-outlined text-xl">close</span>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Convertir cÃ³digo paÃ­s ISO a emoji bandera
  function countryToFlag(countryCode: string): string {
    if (!countryCode || countryCode.length !== 2) return 'ðŸŒ';
    const codePoints = countryCode
      .toUpperCase()
      .split('')
      .map(char => 127397 + char.charCodeAt(0));
    return String.fromCodePoint(...codePoints);
  }

  // Detectar paÃ­s del usuario (con refresh cada 24h)
  async function detectCountry(): Promise<string> {
    const cached = localStorage.getItem('lowis_country');
    const cachedTime = localStorage.getItem('lowis_country_time');
    const now = Date.now();
    const ONE_DAY = 24 * 60 * 60 * 1000;

    // Usar cachÃ© solo si tiene menos de 24 horas
    if (cached && cachedTime && (now - parseInt(cachedTime)) < ONE_DAY) {
      // Disparar evento para que otros componentes sepan el paÃ­s
      window.dispatchEvent(new CustomEvent('lowis-country-detected', { detail: cached }));
      return cached;
    }

    try {
      const res = await fetch('https://ipwho.is/', {
        signal: AbortSignal.timeout(5000) // Timeout 5 segundos
      });
      const data = await res.json();
      if (data.success && data.country_code) {
        localStorage.setItem('lowis_country', data.country_code);
        localStorage.setItem('lowis_country_time', now.toString());
        // Disparar evento para que otros componentes (como Header) filtren opciones
        window.dispatchEvent(new CustomEvent('lowis-country-detected', { detail: data.country_code }));
        return data.country_code;
      }
    } catch (error) {
      console.warn('Geo-detection failed, using cached or default');
      // Si hay cachÃ© aunque estÃ© viejo, usarlo
      if (cached) {
        window.dispatchEvent(new CustomEvent('lowis-country-detected', { detail: cached }));
        return cached;
      }
    }
    // Default basado en la URL actual para evitar mostrar contenido marroquÃ­ incorrectamente
    const path = window.location.pathname;
    let defaultCountry = 'MA'; // Root = Morocco by default
    if (path.startsWith('/en')) defaultCountry = 'US';
    else if (path.startsWith('/es')) defaultCountry = 'ES';
    else if (path.startsWith('/fr')) defaultCountry = 'FR';

    window.dispatchEvent(new CustomEvent('lowis-country-detected', { detail: defaultCountry }));
    return defaultCountry;
  }

  // ConfiguraciÃ³n de mensajes por paÃ­s
  interface CountryConfig {
    lang: string;
    message: string;
    cta: string;
  }

  const countryConfig: Record<string, CountryConfig> = {
    // Marruecos - no mostrar banner
    'MA': { lang: 'fr', message: '', cta: '' },

    // Francia - redirigir a /fr/ (versiÃ³n Francia)
    'FR': { lang: 'fr-FR', message: 'Vous Ãªtes en France ? DÃ©couvrez notre offre de lancement !', cta: 'Voir l\'offre' },

    // Otros francÃ³fonos - mantener en francÃ©s genÃ©rico
    'BE': { lang: 'fr', message: 'Vous Ãªtes en Belgique ? Bienvenue !', cta: 'Continuer' },
    'CH': { lang: 'fr', message: 'Vous Ãªtes en Suisse ? Bienvenue !', cta: 'Continuer' },
    'CA': { lang: 'fr', message: 'Vous Ãªtes au Canada ? Bienvenue !', cta: 'Continuer' },

    // Hispanohablantes
    'ES': { lang: 'es', message: 'Â¿EstÃ¡s en EspaÃ±a? Â¡Bienvenido!', cta: 'Continuar' },
    'MX': { lang: 'es', message: 'Â¿EstÃ¡s en MÃ©xico? Â¡Bienvenido!', cta: 'Continuar' },
    'AR': { lang: 'es', message: 'Â¿EstÃ¡s en Argentina? Â¡Bienvenido!', cta: 'Continuar' },
    'CO': { lang: 'es', message: 'Â¿EstÃ¡s en Colombia? Â¡Bienvenido!', cta: 'Continuar' },
    'CL': { lang: 'es', message: 'Â¿EstÃ¡s en Chile? Â¡Bienvenido!', cta: 'Continuar' },

    // AnglÃ³fonos
    'US': { lang: 'en', message: 'Are you in the US? Welcome!', cta: 'Continue' },
    'GB': { lang: 'en', message: 'Are you in the UK? Welcome!', cta: 'Continue' },
    'AU': { lang: 'en', message: 'Are you in Australia? Welcome!', cta: 'Continue' },
    'IE': { lang: 'en', message: 'Are you in Ireland? Welcome!', cta: 'Continue' },

    // PaÃ­ses Ã¡rabes/magrebÃ­es (mostrar como Marruecos)
    'DZ': { lang: 'fr', message: '', cta: '' }, // Argelia - tratar como MA
    'TN': { lang: 'fr', message: '', cta: '' }, // TÃºnez - tratar como MA
  };

  // Mensaje por defecto para paÃ­ses no listados
  const defaultConfig: Record<string, CountryConfig> = {
    'fr': { lang: 'fr', message: 'Bienvenue ! LOWIS est disponible dans votre pays.', cta: 'Continuer' },
    'es': { lang: 'es', message: 'Â¡Bienvenido! LOWIS estÃ¡ disponible en tu paÃ­s.', cta: 'Continuar' },
    'en': { lang: 'en', message: 'Welcome! LOWIS is available in your country.', cta: 'Continue' },
  };

  // Obtener idioma actual de la URL
  function getCurrentLang(): string {
    const path = window.location.pathname;
    if (path.startsWith('/es')) return 'es';
    if (path.startsWith('/en')) return 'en';
    return 'fr'; // Default
  }

  // Determinar el mejor idioma basado en paÃ­s y navegador
  function getBestLanguage(country: string): string {
    // Francia â†’ versiÃ³n Francia especÃ­fica
    if (country === 'FR') return 'fr-FR';

    // PaÃ­ses hispanohablantes â†’ espaÃ±ol
    const spanishCountries = ['ES', 'MX', 'AR', 'CO', 'CL', 'PE', 'VE', 'EC', 'BO', 'PY', 'UY', 'CR', 'PA', 'DO', 'GT', 'HN', 'SV', 'NI', 'CU', 'PR'];
    if (spanishCountries.includes(country)) return 'es';

    // PaÃ­ses francÃ³fonos (Marruecos y norte de Ãfrica) â†’ francÃ©s marroquÃ­ (raÃ­z)
    const moroccoGroup = ['MA', 'DZ', 'TN'];
    if (moroccoGroup.includes(country)) return 'fr';

    // Otros francÃ³fonos â†’ francÃ©s genÃ©rico (raÃ­z tambiÃ©n)
    const otherFrench = ['BE', 'CH', 'LU', 'MC', 'SN', 'CI', 'CA'];
    if (otherFrench.includes(country)) return 'fr';

    // PaÃ­ses anglÃ³fonos â†’ inglÃ©s
    const englishCountries = ['US', 'GB', 'AU', 'NZ', 'IE', 'ZA', 'IN', 'PH', 'SG'];
    if (englishCountries.includes(country)) return 'en';

    // Para otros paÃ­ses, usar el idioma del navegador si estÃ¡ soportado
    const browserLang = navigator.language.slice(0, 2).toLowerCase();
    if (['es', 'en', 'fr'].includes(browserLang)) {
      return browserLang;
    }

    // Default: inglÃ©s para paÃ­ses no identificados
    return 'en';
  }

  // RedirecciÃ³n automÃ¡tica de idioma (solo en pÃ¡gina raÃ­z)
  async function autoRedirectLanguage() {
    const path = window.location.pathname;

    // Solo redirigir si estamos en la raÃ­z exacta
    if (path !== '/' && path !== '') return;

    // No redirigir si el usuario ya eligiÃ³ un idioma (tiene flag en localStorage)
    const userChoseLang = localStorage.getItem('lowis_lang_chosen');
    if (userChoseLang) return;

    const country = await detectCountry();
    const bestLang = getBestLanguage(country);

    // Si el mejor idioma no es francÃ©s (Marruecos), redirigir
    if (bestLang === 'fr-FR') {
      // Francia â†’ /fr/
      localStorage.setItem('lowis_auto_redirected', 'true');
      window.location.href = '/fr/';
    } else if (bestLang !== 'fr') {
      // Otros idiomas â†’ /{lang}/
      localStorage.setItem('lowis_auto_redirected', 'true');
      window.location.href = `/${bestLang}/`;
    }
  }

  // Adaptar contenido segÃºn paÃ­s - usa opacity/visibility para evitar CLS
  function adaptContentForCountry(country: string) {
    const moroccoGroup = ['MA', 'DZ', 'TN'];
    const isMorocco = moroccoGroup.includes(country);
    const path = window.location.pathname;

    // Si estÃ¡ en Marruecos y en /fr/ â†’ redirigir a / (evitar duplicado SEO)
    // /es/ y /en/ SÃ estÃ¡n permitidos (misma landing traducida)
    if (isMorocco && path.startsWith('/fr')) {
      const cleanPath = path.replace(/^\/fr/, '') || '/';
      window.location.href = cleanPath;
      return;
    }

    if (isMorocco) {
      // Usuario de Marruecos: mostrar contenido especÃ­fico, ocultar genÃ©rico
      document.querySelectorAll('[data-morocco-only]').forEach(el => {
        const htmlEl = el as HTMLElement;
        htmlEl.style.opacity = '1';
        htmlEl.style.visibility = 'visible';
      });
      document.querySelectorAll('[data-generic-only]').forEach(el => {
        const htmlEl = el as HTMLElement;
        htmlEl.style.opacity = '0';
        htmlEl.style.visibility = 'hidden';
      });
    } else {
      // Usuario fuera de Marruecos: ocultar contenido especÃ­fico, mostrar genÃ©rico
      document.querySelectorAll('[data-morocco-only]').forEach(el => {
        const htmlEl = el as HTMLElement;
        htmlEl.style.opacity = '0';
        htmlEl.style.visibility = 'hidden';
      });
      document.querySelectorAll('[data-generic-only]').forEach(el => {
        const htmlEl = el as HTMLElement;
        htmlEl.style.opacity = '1';
        htmlEl.style.visibility = 'visible';
      });

      // Actualizar textos dinÃ¡micos si existen
      document.querySelectorAll('[data-morocco-text]').forEach(el => {
        const genericText = el.getAttribute('data-generic-text');
        if (genericText) {
          el.textContent = genericText;
        }
      });
    }
  }

  // Inicializar geo-banner (solo el banner de bienvenida)
  async function initGeoBanner() {
    const country = await detectCountry();
    const dismissed = localStorage.getItem('lowis_banner_dismissed');

    // SIEMPRE adaptar contenido segÃºn paÃ­s (independiente del banner)
    adaptContentForCountry(country);

    // El banner solo se muestra para paÃ­ses no-Marruecos que no lo han cerrado
    const moroccoGroup = ['MA', 'DZ', 'TN'];
    if (moroccoGroup.includes(country) || dismissed) {
      return; // No mostrar banner, pero el contenido ya fue adaptado arriba
    }

    // Obtener configuraciÃ³n del paÃ­s o usar default
    const currentLang = getCurrentLang();
    let config = countryConfig[country];

    if (!config || !config.message) {
      config = defaultConfig[currentLang];
    }

    // Actualizar banner
    const flagEl = document.getElementById('country-flag');
    const messageEl = document.getElementById('banner-message');
    const ctaEl = document.getElementById('banner-cta');
    const bannerEl = document.getElementById('geo-banner');

    if (flagEl) flagEl.textContent = countryToFlag(country);
    if (messageEl) messageEl.textContent = config.message;
    if (ctaEl) ctaEl.textContent = config.cta;

    // Animar entrada del banner despuÃ©s de un pequeÃ±o delay
    setTimeout(() => {
      if (bannerEl) {
        bannerEl.classList.remove('-translate-y-full');
      }
    }, 1500);
  }

  // Event listeners para cerrar el banner
  function setupBannerEvents() {
    const dismissBtn = document.getElementById('banner-dismiss');
    const ctaBtn = document.getElementById('banner-cta');
    const bannerEl = document.getElementById('geo-banner');

    const closeBanner = () => {
      localStorage.setItem('lowis_banner_dismissed', 'true');
      if (bannerEl) {
        bannerEl.classList.add('-translate-y-full');
      }
    };

    // X button just closes the banner
    dismissBtn?.addEventListener('click', closeBanner);

    // CTA button redirects to the correct language AND closes the banner
    ctaBtn?.addEventListener('click', async () => {
      closeBanner();

      // Get detected country and determine best language
      const country = localStorage.getItem('lowis_country') || 'MA';
      const bestLang = getBestLanguage(country);
      const currentLang = getCurrentLang();

      // Mark that user accepted language selection
      localStorage.setItem('lowis_lang_chosen', bestLang);

      // Only redirect if different from current language
      if (bestLang === 'fr-FR' && currentLang !== 'fr-FR') {
        // France â†’ /fr/
        window.location.href = '/fr' + window.location.pathname.replace(/^\/(es|en)/, '');
      } else if (bestLang !== currentLang && bestLang !== 'fr-FR') {
        // Other languages
        const cleanPath = window.location.pathname.replace(/^\/(fr|es|en)/, '') || '/';
        if (bestLang === 'fr') {
          // Moroccan French â†’ root (no prefix)
          window.location.href = cleanPath;
        } else {
          // Spanish or English â†’ /{lang}/
          window.location.href = '/' + bestLang + cleanPath;
        }
      }
    });
  }

  // =========================================================================
  // INIT - Optimizado para no bloquear LCP pero mantener funcionalidad completa
  // =========================================================================

  // Ejecutar cuando el DOM estÃ© listo
  async function init() {
    // Setup events inmediatamente (no bloquea, es sync)
    setupBannerEvents();

    // PASO 1: Verificar cache primero (instantÃ¡neo, no bloquea)
    const cachedCountry = localStorage.getItem('lowis_country');
    const cachedTime = localStorage.getItem('lowis_country_time');
    const ONE_DAY = 24 * 60 * 60 * 1000;
    const cacheValid = cachedCountry && cachedTime && (Date.now() - parseInt(cachedTime)) < ONE_DAY;

    if (cacheValid) {
      // Cache vÃ¡lido: usar inmediatamente sin fetch
      handleCountryDetected(cachedCountry!);
      return;
    }

    if (cachedCountry && !cacheValid) {
      // Cache expirado: usar el valor viejo inmediatamente, refrescar en background
      handleCountryDetected(cachedCountry);
      refreshCountryInBackground();
      return;
    }

    // Sin cache: necesitamos hacer fetch, pero lo hacemos de forma inteligente
    // Si estamos en la raÃ­z Y el usuario no ha elegido idioma, necesitamos esperar
    const path = window.location.pathname;
    const needsRedirect = (path === '/' || path === '') && !localStorage.getItem('lowis_lang_chosen');

    if (needsRedirect) {
      // CASO CRÃTICO: Primera visita a raÃ­z - necesitamos geo para redirigir
      // Hacer fetch pero con timeout corto para no bloquear mucho
      const country = await detectCountryFast();
      const bestLang = getBestLanguage(country);

      if (bestLang === 'fr-FR') {
        localStorage.setItem('lowis_auto_redirected', 'true');
        window.location.href = '/fr/';
        return;
      } else if (bestLang !== 'fr') {
        localStorage.setItem('lowis_auto_redirected', 'true');
        window.location.href = `/${bestLang}/`;
        return;
      }

      // Si es francÃ©s marroquÃ­, continuar normal
      handleCountryDetected(country);
    } else {
      // No necesita redirigir: defer la detecciÃ³n para no bloquear LCP
      if ('requestIdleCallback' in window) {
        (window as any).requestIdleCallback(() => detectAndHandle(), { timeout: 2000 });
      } else {
        setTimeout(() => detectAndHandle(), 50);
      }
    }
  }

  // Detectar paÃ­s con timeout mÃ¡s corto para casos crÃ­ticos de redirecciÃ³n
  async function detectCountryFast(): Promise<string> {
    try {
      const res = await fetch('https://ipwho.is/', { signal: AbortSignal.timeout(2000) });
      const data = await res.json();
      if (data.success && data.country_code) {
        localStorage.setItem('lowis_country', data.country_code);
        localStorage.setItem('lowis_country_time', Date.now().toString());
        return data.country_code;
      }
    } catch {
      // Timeout o error: usar default basado en URL
    }
    return getDefaultCountry();
  }

  // Detectar y manejar (para casos no crÃ­ticos)
  async function detectAndHandle() {
    const country = await detectCountry();
    handleCountryDetected(country);
  }

  // Manejar paÃ­s detectado: adaptar contenido y mostrar banner
  function handleCountryDetected(country: string) {
    window.dispatchEvent(new CustomEvent('lowis-country-detected', { detail: country }));
    adaptContentForCountry(country);

    // Banner solo para no-Marruecos que no lo han cerrado
    const moroccoGroup = ['MA', 'DZ', 'TN'];
    const dismissed = localStorage.getItem('lowis_banner_dismissed');
    if (!moroccoGroup.includes(country) && !dismissed) {
      showBannerForCountry(country);
    }
  }

  // Obtener paÃ­s default basado en URL
  function getDefaultCountry(): string {
    const path = window.location.pathname;
    if (path.startsWith('/en')) return 'US';
    if (path.startsWith('/es')) return 'ES';
    if (path.startsWith('/fr')) return 'FR';
    return 'MA';
  }

  // Refrescar paÃ­s en background (no bloquea nada)
  async function refreshCountryInBackground() {
    try {
      const res = await fetch('https://ipwho.is/', { signal: AbortSignal.timeout(5000) });
      const data = await res.json();
      if (data.success && data.country_code) {
        localStorage.setItem('lowis_country', data.country_code);
        localStorage.setItem('lowis_country_time', Date.now().toString());
      }
    } catch {
      // Silently fail
    }
  }

  // Mostrar banner para un paÃ­s especÃ­fico
  function showBannerForCountry(country: string) {
    const currentLang = getCurrentLang();
    let config = countryConfig[country];
    if (!config || !config.message) {
      config = defaultConfig[currentLang];
    }

    const flagEl = document.getElementById('country-flag');
    const messageEl = document.getElementById('banner-message');
    const ctaEl = document.getElementById('banner-cta');
    const bannerEl = document.getElementById('geo-banner');

    if (flagEl) flagEl.textContent = countryToFlag(country);
    if (messageEl) messageEl.textContent = config.message;
    if (ctaEl) ctaEl.textContent = config.cta;

    setTimeout(() => {
      if (bannerEl) bannerEl.classList.remove('-translate-y-full');
    }, 1500);
  }

  // Iniciar
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>

<style>
  #geo-banner {
    /* Asegurar que estÃ© por encima del header */
    z-index: 100;
  }

  /* AnimaciÃ³n suave para el banner */
  #geo-banner.show {
    transform: translateY(0);
  }
</style>
