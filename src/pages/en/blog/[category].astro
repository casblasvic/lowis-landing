---
/**
 * Blog Category Page - English
 *
 * /en/blog/[category]/ - SEO silo pages for each category
 * Dedicated landing pages for category-based SEO positioning
 *
 * NEW URL STRUCTURE (removed /category/ from path):
 * - Before: /en/blog/category/guides/
 * - After:  /en/blog/guides/
 */
import { getCollection } from 'astro:content';
import BlogLayout from '../../../layouts/BlogLayout.astro';
import CTABanner from '../../../components/blog/CTABanner.astro';
import CategoryFAQ from '../../../components/blog/CategoryFAQ.astro';
import { getBlogImageUrl } from '../../../lib/storage';
import { categoryContentEN } from '../../../data/categoryContent';

const lang = 'en';

// List of all valid categories (used to differentiate from post slugs)
const VALID_CATEGORIES = ['guides', 'comparatifs', 'astuces', 'recettes', 'temoignages', 'bien-etre', 'mindset', 'sante-femme'];

// Category configuration with SEO data
const categoryConfig: Record<string, {
  label: string;
  icon: string;
  color: string;
  title: string;
  description: string;
  keywords: string;
}> = {
  guides: {
    label: 'Guides',
    icon: 'menu_book',
    color: '#059669',
    title: 'Nutrition & Weight Loss Guides | LOWIS Blog',
    description: 'Comprehensive guides on nutrition, weight loss, and wellness. Expert tips and personalized plans powered by LOWIS AI.',
    keywords: 'nutrition guide, weight loss guide, diet tips, healthy eating, meal planning'
  },
  comparatifs: {
    label: 'Comparisons',
    icon: 'compare',
    color: '#7C3AED',
    title: 'Nutrition App Comparisons | LOWIS vs Alternatives',
    description: 'Detailed comparisons between LOWIS and other nutrition apps. Discover which app best fits your needs.',
    keywords: 'nutrition app comparison, myfitnesspal alternative, yazio review, lose it comparison, best calorie app'
  },
  astuces: {
    label: 'Tips',
    icon: 'lightbulb',
    color: '#F59E0B',
    title: 'Nutrition & Weight Loss Tips | Practical Advice',
    description: 'Practical tips for effective weight loss. Daily advice for healthy eating habits.',
    keywords: 'weight loss tips, nutrition advice, healthy habits, diet tips, wellness'
  },
  recettes: {
    label: 'Recipes',
    icon: 'restaurant',
    color: '#EF4444',
    title: 'Healthy & Balanced Recipes | Nutritious Cooking',
    description: 'Healthy recipes for the whole family. Delicious and nutritious dishes for your diet.',
    keywords: 'healthy recipes, diet recipes, low calorie meals, nutritious cooking, healthy eating'
  },
  temoignages: {
    label: 'Success Stories',
    icon: 'chat',
    color: '#3B82F6',
    title: 'Testimonials & Results | LOWIS Success Stories',
    description: 'Discover testimonials from our users and their results with LOWIS. Real transformation stories.',
    keywords: 'weight loss testimonials, diet results, before after, success stories, transformation'
  },
  'bien-etre': {
    label: 'Wellness',
    icon: 'self_improvement',
    color: '#10B981',
    title: 'Wellness & Mental Health | LOWIS Blog',
    description: 'Articles on wellness, stress management, and mental health. Discover how your mind influences your weight.',
    keywords: 'wellness, mental health, stress weight loss, sleep diet, life balance'
  },
  mindset: {
    label: 'Mindset',
    icon: 'psychology',
    color: '#8B5CF6',
    title: 'Mindset & Mental Reprogramming | LOWIS Blog',
    description: 'Articles on mindset, mental reprogramming, and weight loss psychology. Change your relationship with food.',
    keywords: 'mindset weight loss, food psychology, mental reprogramming, eating habits'
  },
  'sante-femme': {
    label: "Women's Health",
    icon: 'female',
    color: '#EC4899',
    title: "Women's Health & Nutrition | LOWIS Blog",
    description: "Articles on women's health, menstrual cycle, and nutrition adapted to women. Personalized nutrition based on your hormones.",
    keywords: "women's health, menstrual cycle nutrition, hormones weight, women's nutrition, female diet"
  },
};

// Generate static paths for all categories
export async function getStaticPaths() {
  const categories = ['guides', 'comparatifs', 'astuces', 'recettes', 'temoignages', 'bien-etre', 'mindset', 'sante-femme'];
  return categories.map((category) => ({
    params: { category },
  }));
}

const { category } = Astro.params;
const config = categoryConfig[category];

if (!config) {
  return Astro.redirect('/en/blog/');
}

/**
 * Resolve image path to full URL
 */
function resolveImageUrl(imagePath: string | undefined): string | undefined {
  if (!imagePath) return undefined;
  if (imagePath.startsWith('http') || imagePath.startsWith('/')) return imagePath;
  return getBlogImageUrl(imagePath);
}

// Helper to extract slug from post id
function getSlugFromId(id: string): string {
  return id.replace(/^en\//, '').replace(/\.md$/, '');
}

// Get all English blog posts in this category
const allPosts = await getCollection('blog', ({ data }) => {
  return data.lang === lang && !data.draft && data.category === category;
});

// Sort by publish date (newest first)
const posts = allPosts.sort((a, b) =>
  b.data.publishDate.getTime() - a.data.publishDate.getTime()
);

// Get all posts for category counts (for navigation)
const allBlogPosts = await getCollection('blog', ({ data }) => {
  return data.lang === lang && !data.draft;
});

// Get used categories for navigation pills
const usedCategories = [...new Set(allBlogPosts.map(p => p.data.category).filter(Boolean))] as string[];

// Get SEO content for this category (extended description + FAQs)
const categoryContent = categoryContentEN[category];
---

<BlogLayout
  title={config.title}
  description={config.description}
  keywords={config.keywords}
  lang={lang}
>
  <!-- Category Hero -->
  <section class="py-12 md:py-16" style="background: var(--blog-bg);">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <!-- Category badge -->
      <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-white font-medium mb-6 notranslate" translate="no" style={`background: ${config.color};`}>
        <span class="material-symbols-outlined">{config.icon}</span>
        {config.label}
      </div>

      <h1 class="text-4xl md:text-5xl font-bold mb-6 tracking-tight" style="color: var(--blog-text);">
        {config.label}
      </h1>
      <p class="text-lg md:text-xl max-w-2xl mx-auto leading-relaxed" style="color: var(--blog-text-secondary);">
        {config.description}
      </p>

      <!-- Breadcrumb -->
      <nav class="mt-8 text-sm" style="color: var(--blog-text-muted);">
        <a href="/en/blog/" class="hover:underline" style="color: var(--blog-accent);">Blog</a>
        <span class="mx-2">â€º</span>
        <span>{config.label}</span>
      </nav>
    </div>
  </section>

  <!-- Category Navigation Pills -->
  {usedCategories.length > 0 && (
    <section class="pb-8" style="background: var(--blog-bg);">
      <div class="max-w-6xl mx-auto">
        <div class="category-scroll-container overflow-x-auto scrollbar-hide px-4 sm:px-6 lg:px-8">
          <div class="flex items-center gap-2 md:gap-3 md:justify-center min-w-max md:min-w-0">
            <a
              href="/en/blog/"
              class="inline-flex items-center gap-1.5 px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 whitespace-nowrap notranslate hover:scale-105"
              translate="no"
              style="background: var(--blog-surface); color: var(--blog-text-secondary); border: 1px solid var(--blog-border);"
            >
              <span class="material-symbols-outlined text-base">apps</span>
              All
            </a>
            {usedCategories.map((cat) => {
              const catConfig = categoryConfig[cat];
              if (!catConfig) return null;
              const isActive = cat === category;
              return (
                <a
                  href={`/en/blog/${cat}/`}
                  class="inline-flex items-center gap-1.5 px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 whitespace-nowrap notranslate hover:scale-105"
                  translate="no"
                  style={isActive
                    ? `background: ${catConfig.color}; color: white; border: 1px solid ${catConfig.color};`
                    : `background: ${catConfig.color}15; color: ${catConfig.color}; border: 1px solid ${catConfig.color}30;`}
                >
                  <span class="material-symbols-outlined text-base">{catConfig.icon}</span>
                  {catConfig.label}
                </a>
              );
            })}
          </div>
        </div>
      </div>
    </section>
  )}

  <!-- Extended Description for SEO -->
  {categoryContent?.extendedDescription && (
    <section class="py-8 md:py-12" style="background: var(--blog-bg);">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div
          class="prose prose-lg max-w-none"
          style="color: var(--blog-text-secondary);"
        >
          {categoryContent.extendedDescription.split('\n\n').map((paragraph) => (
            <p class="mb-4 leading-relaxed">{paragraph}</p>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Posts Section -->
  <section class="pb-16 md:pb-24">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      {posts.length > 0 ? (
        <>
          <!-- Posts count -->
          <div class="flex items-center justify-between mb-8">
            <p class="text-sm font-medium" style="color: var(--blog-text-muted);">
              {posts.length} article{posts.length > 1 ? 's' : ''} in this category
            </p>
          </div>

          <!-- Posts Grid -->
          <div class="grid gap-6 md:gap-8 sm:grid-cols-2 lg:grid-cols-3">
            {posts.map((post) => (
              <a
                href={`/en/blog/${getSlugFromId(post.id)}/`}
                class="group block"
              >
                <article class="h-full rounded-xl overflow-hidden transition-all duration-300 group-hover:shadow-lg group-hover:-translate-y-1" style="background: var(--blog-surface); border: 1px solid var(--blog-border);">
                  <!-- Image -->
                  <div class="relative aspect-[16/10] overflow-hidden">
                    {post.data.image ? (
                      <img
                        src={resolveImageUrl(post.data.image)}
                        alt={post.data.imageAlt || post.data.title}
                        class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                        loading="lazy"
                      />
                    ) : (
                      <div class="w-full h-full flex items-center justify-center" style={`background: linear-gradient(135deg, ${config.color}20, var(--blog-surface));`}>
                        <span class="material-symbols-outlined" style={`font-size: 3rem; color: ${config.color}; opacity: 0.5;`}>article</span>
                      </div>
                    )}
                    <!-- Category badge -->
                    <span
                      class="absolute top-3 left-3 inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium text-white notranslate"
                      translate="no"
                      style={`background: ${config.color};`}
                    >
                      <span class="material-symbols-outlined text-xs">{config.icon}</span>
                      {config.label}
                    </span>
                  </div>

                  <!-- Content -->
                  <div class="p-5">
                    {post.data.readingTime && (
                      <div class="flex items-center gap-2 mb-2">
                        <span class="text-xs" style="color: var(--blog-text-muted);">
                          {post.data.readingTime} min read
                        </span>
                      </div>
                    )}
                    <h2 class="font-bold text-lg mb-2 leading-snug group-hover:text-[var(--blog-accent)] transition-colors line-clamp-2" style="color: var(--blog-text);">
                      {post.data.title}
                    </h2>
                    <p class="text-sm leading-relaxed line-clamp-2" style="color: var(--blog-text-secondary);">
                      {post.data.description}
                    </p>
                  </div>
                </article>
              </a>
            ))}
          </div>
        </>
      ) : (
        <!-- Empty state -->
        <div class="text-center py-20">
          <div class="inline-flex items-center justify-center w-20 h-20 rounded-full mb-6" style={`background: ${config.color}20;`}>
            <span class="material-symbols-outlined text-4xl" style={`color: ${config.color};`}>{config.icon}</span>
          </div>
          <h2 class="text-2xl font-bold mb-3" style="color: var(--blog-text);">
            Coming Soon
          </h2>
          <p class="mb-8 max-w-md mx-auto" style="color: var(--blog-text-secondary);">
            {config.label} articles are coming soon. In the meantime, check out our other content!
          </p>
          <a
            href="/en/blog/"
            class="inline-flex items-center gap-2 px-6 py-3 rounded-xl font-semibold text-white transition-transform hover:scale-105"
            style="background: var(--blog-accent);"
          >
            View all articles
            <span class="material-symbols-outlined">arrow_forward</span>
          </a>
        </div>
      )}
    </div>
  </section>

  <!-- FAQ Section with Schema markup -->
  {categoryContent?.faqs && categoryContent.faqs.length > 0 && (
    <CategoryFAQ
      faqs={categoryContent.faqs}
      categoryColor={config.color}
      title="Frequently Asked Questions"
    />
  )}

  <!-- Bottom CTA -->
  <section class="py-16" style="background: var(--blog-bg);">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <CTABanner lang={lang} type="trial" variant="gradient" />
    </div>
  </section>
</BlogLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Horizontal scroll container - hide scrollbar */
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

</style>
