---
/**
 * Blog Category Page - French (France)
 *
 * /fr/blog/[category]/ - SEO silo pages for each category
 * Dedicated landing pages for category-based SEO positioning
 *
 * NEW URL STRUCTURE (removed /category/ from path):
 * - Before: /fr/blog/category/guides/
 * - After:  /fr/blog/guides/
 */
import { getCollection } from 'astro:content';
import BlogLayout from '../../../layouts/BlogLayout.astro';
import CTABanner from '../../../components/blog/CTABanner.astro';
import { getBlogImageUrl } from '../../../lib/storage';

const lang = 'fr-FR';

// List of all valid categories (used to differentiate from post slugs)
const VALID_CATEGORIES = ['guides', 'comparatifs', 'astuces', 'recettes', 'temoignages', 'bien-etre', 'mindset', 'sante-femme'];

// Category configuration with SEO data
const categoryConfig: Record<string, {
  label: string;
  icon: string;
  color: string;
  title: string;
  description: string;
  keywords: string;
}> = {
  guides: {
    label: 'Guides',
    icon: 'menu_book',
    color: '#059669',
    title: 'Guides Nutrition et Perte de Poids | Blog LOWIS',
    description: 'Guides complets sur la nutrition, la perte de poids et le bien-être. Conseils experts et plans personnalisés avec l\'IA LOWIS.',
    keywords: 'guide nutrition, guide perte de poids, conseils régime, nutrition france, plan alimentaire'
  },
  comparatifs: {
    label: 'Comparatifs',
    icon: 'compare',
    color: '#7C3AED',
    title: 'Comparatifs Apps Nutrition | LOWIS vs Alternatives',
    description: 'Comparaisons détaillées entre LOWIS et les autres applications de nutrition. Découvrez quelle app correspond le mieux à vos besoins.',
    keywords: 'comparatif app nutrition, myfitnesspal alternative, yazio avis, lose it comparaison, meilleure app calories'
  },
  astuces: {
    label: 'Astuces',
    icon: 'lightbulb',
    color: '#F59E0B',
    title: 'Astuces Nutrition et Minceur | Conseils Pratiques',
    description: 'Astuces pratiques pour perdre du poids efficacement. Conseils quotidiens pour une alimentation saine au quotidien.',
    keywords: 'astuces minceur, conseils perte poids, tips nutrition, habitudes saines, alimentation équilibrée'
  },
  recettes: {
    label: 'Recettes',
    icon: 'restaurant',
    color: '#EF4444',
    title: 'Recettes Healthy et Équilibrées | Cuisine Saine',
    description: 'Recettes saines et équilibrées pour toute la famille. Plats délicieux et nutritifs pour votre régime.',
    keywords: 'recettes healthy, cuisine saine, recettes régime, plats basses calories, recettes diététiques'
  },
  temoignages: {
    label: 'Témoignages',
    icon: 'chat',
    color: '#3B82F6',
    title: 'Témoignages et Résultats | Réussites LOWIS',
    description: 'Découvrez les témoignages de nos utilisateurs et leurs résultats avec LOWIS. Histoires de transformation réelles.',
    keywords: 'témoignages perte poids, résultats régime, avant après, success stories, transformation'
  },
  'bien-etre': {
    label: 'Bien-être',
    icon: 'self_improvement',
    color: '#10B981',
    title: 'Bien-être et Santé Mentale | Blog LOWIS',
    description: 'Articles sur le bien-être, la gestion du stress et la santé mentale. Découvrez comment votre mental influence votre poids.',
    keywords: 'bien-être, santé mentale, stress perte poids, sommeil régime, équilibre vie'
  },
  mindset: {
    label: 'Mindset',
    icon: 'psychology',
    color: '#8B5CF6',
    title: 'Mindset et Reprogrammation Mentale | Blog LOWIS',
    description: 'Articles sur le mindset, la reprogrammation mentale et la psychologie de la perte de poids. Changez votre relation avec la nourriture.',
    keywords: 'mindset perte poids, psychologie alimentation, reprogrammation mentale, habitudes alimentaires'
  },
  'sante-femme': {
    label: 'Santé Femme',
    icon: 'female',
    color: '#EC4899',
    title: 'Santé Féminine et Nutrition | Blog LOWIS',
    description: 'Articles sur la santé féminine, le cycle menstruel et l\'alimentation adaptée aux femmes. Nutrition personnalisée selon vos hormones.',
    keywords: 'santé femme, cycle menstruel alimentation, hormones poids, nutrition féminine, régime femme'
  },
};

// Generate static paths for all categories
export async function getStaticPaths() {
  const categories = ['guides', 'comparatifs', 'astuces', 'recettes', 'temoignages', 'bien-etre', 'mindset', 'sante-femme'];
  return categories.map((category) => ({
    params: { category },
  }));
}

const { category } = Astro.params;
const config = categoryConfig[category];

if (!config) {
  return Astro.redirect('/fr/blog/');
}

/**
 * Resolve image path to full URL
 */
function resolveImageUrl(imagePath: string | undefined): string | undefined {
  if (!imagePath) return undefined;
  if (imagePath.startsWith('http') || imagePath.startsWith('/')) return imagePath;
  return getBlogImageUrl(imagePath);
}

// Helper to extract slug from post id
function getSlugFromId(id: string): string {
  return id.replace(/^(fr|fr-FR)\//, '').replace(/\.md$/, '');
}

// Get all French blog posts in this category (both fr and fr-FR)
const allPosts = await getCollection('blog', ({ data }) => {
  return (data.lang === 'fr-FR' || data.lang === 'fr') && !data.draft && data.category === category;
});

// Sort by publish date (newest first)
const posts = allPosts.sort((a, b) =>
  b.data.publishDate.getTime() - a.data.publishDate.getTime()
);

// Get all posts for category counts (for navigation)
const allBlogPosts = await getCollection('blog', ({ data }) => {
  return (data.lang === 'fr-FR' || data.lang === 'fr') && !data.draft;
});

// Get used categories for navigation pills
const usedCategories = [...new Set(allBlogPosts.map(p => p.data.category).filter(Boolean))] as string[];
---

<BlogLayout
  title={config.title}
  description={config.description}
  keywords={config.keywords}
  lang={lang}
>
  <!-- Category Hero -->
  <section class="py-12 md:py-16" style="background: var(--blog-bg);">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <!-- Category badge -->
      <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-white font-medium mb-6 notranslate" translate="no" style={`background: ${config.color};`}>
        <span class="material-symbols-outlined">{config.icon}</span>
        {config.label}
      </div>

      <h1 class="text-4xl md:text-5xl font-bold mb-6 tracking-tight" style="color: var(--blog-text);">
        {config.label}
      </h1>
      <p class="text-lg md:text-xl max-w-2xl mx-auto leading-relaxed" style="color: var(--blog-text-secondary);">
        {config.description}
      </p>

      <!-- Breadcrumb -->
      <nav class="mt-8 text-sm" style="color: var(--blog-text-muted);">
        <a href="/fr/blog/" class="hover:underline" style="color: var(--blog-accent);">Blog</a>
        <span class="mx-2">›</span>
        <span>{config.label}</span>
      </nav>
    </div>
  </section>

  <!-- Category Navigation Pills -->
  {usedCategories.length > 0 && (
    <section class="pb-8" style="background: var(--blog-bg);">
      <div class="max-w-6xl mx-auto">
        <div class="category-scroll-container overflow-x-auto scrollbar-hide px-4 sm:px-6 lg:px-8">
          <div class="flex items-center gap-2 md:gap-3 md:justify-center min-w-max md:min-w-0">
            <a
              href="/fr/blog/"
              class="category-pill inline-flex items-center gap-1.5 px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 whitespace-nowrap notranslate"
              translate="no"
            >
              <span class="material-symbols-outlined text-base">apps</span>
              Tous
            </a>
            {usedCategories.map((cat) => {
              const catConfig = categoryConfig[cat];
              if (!catConfig) return null;
              const isActive = cat === category;
              return (
                <a
                  href={`/fr/blog/${cat}/`}
                  class={`category-pill inline-flex items-center gap-1.5 px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 whitespace-nowrap notranslate ${isActive ? 'active' : ''}`}
                  translate="no"
                  style={isActive ? `background: ${catConfig.color}; border-color: ${catConfig.color}; color: white;` : ''}
                >
                  <span class="material-symbols-outlined text-base">{catConfig.icon}</span>
                  {catConfig.label}
                </a>
              );
            })}
          </div>
        </div>
      </div>
    </section>
  )}

  <!-- Posts Section -->
  <section class="pb-16 md:pb-24">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      {posts.length > 0 ? (
        <>
          <!-- Posts count -->
          <div class="flex items-center justify-between mb-8">
            <p class="text-sm font-medium" style="color: var(--blog-text-muted);">
              {posts.length} article{posts.length > 1 ? 's' : ''} dans cette catégorie
            </p>
          </div>

          <!-- Posts Grid -->
          <div class="grid gap-6 md:gap-8 sm:grid-cols-2 lg:grid-cols-3">
            {posts.map((post) => (
              <a
                href={`/fr/blog/${getSlugFromId(post.id)}/`}
                class="group block"
              >
                <article class="h-full rounded-xl overflow-hidden transition-all duration-300 group-hover:shadow-lg group-hover:-translate-y-1" style="background: var(--blog-surface); border: 1px solid var(--blog-border);">
                  <!-- Image -->
                  <div class="relative aspect-[16/10] overflow-hidden">
                    {post.data.image ? (
                      <img
                        src={resolveImageUrl(post.data.image)}
                        alt={post.data.imageAlt || post.data.title}
                        class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                        loading="lazy"
                      />
                    ) : (
                      <div class="w-full h-full flex items-center justify-center" style={`background: linear-gradient(135deg, ${config.color}20, var(--blog-surface));`}>
                        <span class="material-symbols-outlined" style={`font-size: 3rem; color: ${config.color}; opacity: 0.5;`}>article</span>
                      </div>
                    )}
                    <!-- Category badge -->
                    <span
                      class="absolute top-3 left-3 inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium text-white notranslate"
                      translate="no"
                      style={`background: ${config.color};`}
                    >
                      <span class="material-symbols-outlined text-xs">{config.icon}</span>
                      {config.label}
                    </span>
                  </div>

                  <!-- Content -->
                  <div class="p-5">
                    {post.data.readingTime && (
                      <div class="flex items-center gap-2 mb-2">
                        <span class="text-xs" style="color: var(--blog-text-muted);">
                          {post.data.readingTime} min de lecture
                        </span>
                      </div>
                    )}
                    <h2 class="font-bold text-lg mb-2 leading-snug group-hover:text-[var(--blog-accent)] transition-colors line-clamp-2" style="color: var(--blog-text);">
                      {post.data.title}
                    </h2>
                    <p class="text-sm leading-relaxed line-clamp-2" style="color: var(--blog-text-secondary);">
                      {post.data.description}
                    </p>
                  </div>
                </article>
              </a>
            ))}
          </div>
        </>
      ) : (
        <!-- Empty state -->
        <div class="text-center py-20">
          <div class="inline-flex items-center justify-center w-20 h-20 rounded-full mb-6" style={`background: ${config.color}20;`}>
            <span class="material-symbols-outlined text-4xl" style={`color: ${config.color};`}>{config.icon}</span>
          </div>
          <h2 class="text-2xl font-bold mb-3" style="color: var(--blog-text);">
            Bientôt disponible
          </h2>
          <p class="mb-8 max-w-md mx-auto" style="color: var(--blog-text-secondary);">
            Les articles {config.label.toLowerCase()} arrivent très prochainement. En attendant, découvrez nos autres contenus !
          </p>
          <a
            href="/fr/blog/"
            class="inline-flex items-center gap-2 px-6 py-3 rounded-xl font-semibold text-white transition-transform hover:scale-105"
            style="background: var(--blog-accent);"
          >
            Voir tous les articles
            <span class="material-symbols-outlined">arrow_forward</span>
          </a>
        </div>
      )}
    </div>
  </section>

  <!-- Related Categories -->
  <section class="py-12" style="background: var(--blog-surface);">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-lg font-semibold mb-6 text-center" style="color: var(--blog-text);">
        Autres catégories
      </h2>
      <div class="flex flex-wrap justify-center gap-3">
        {Object.entries(categoryConfig).map(([key, cat]) => (
          key !== category && (
            <a
              href={`/fr/blog/${key}/`}
              class="inline-flex items-center gap-1.5 px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 hover:scale-105 notranslate"
              translate="no"
              style={`background: ${cat.color}15; color: ${cat.color}; border: 1px solid ${cat.color}30;`}
            >
              <span class="material-symbols-outlined text-base">{cat.icon}</span>
              {cat.label}
            </a>
          )
        ))}
      </div>
    </div>
  </section>

  <!-- Bottom CTA -->
  <section class="py-16" style="background: var(--blog-bg);">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <CTABanner lang={lang} type="trial" variant="gradient" />
    </div>
  </section>
</BlogLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Horizontal scroll container - hide scrollbar */
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  /* Category pill styles */
  .category-pill {
    background: var(--blog-surface);
    border: 1px solid var(--blog-border);
    color: var(--blog-text-secondary);
    cursor: pointer;
    flex-shrink: 0;
  }
  .category-pill:hover {
    border-color: var(--blog-accent);
    color: var(--blog-accent);
  }
  .category-pill.active {
    color: white;
  }
</style>
