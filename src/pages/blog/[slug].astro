---
/**
 * Blog Post - French (Morocco) - Default
 *
 * /blog/[slug]/ - Individual blog post in French
 */
import { getCollection, render } from 'astro:content';
import BlogLayout from '../../layouts/BlogLayout.astro';
import CTABanner from '../../components/blog/CTABanner.astro';
import AuthorBox from '../../components/blog/AuthorBox.astro';
import RelatedPosts from '../../components/blog/RelatedPosts.astro';
import { getBlogImageUrl } from '../../lib/storage';

const lang = 'fr';

/**
 * Resolve image path to full URL
 * - If starts with "http" ‚Üí keep as-is
 * - If starts with "/" ‚Üí legacy local path, keep as-is
 * - Otherwise ‚Üí treat as Supabase storage path
 */
function resolveImageUrl(imagePath: string | undefined): string | undefined {
  if (!imagePath) return undefined;
  if (imagePath.startsWith('http') || imagePath.startsWith('/')) return imagePath;
  return getBlogImageUrl(imagePath);
}

// Helper to extract slug from post id (e.g., "fr/lowis-vs-cal-ai" -> "lowis-vs-cal-ai")
function getSlugFromId(id: string): string {
  return id.replace(/^fr\//, '').replace(/\.md$/, '');
}

// Generate static paths for all French posts
export async function getStaticPaths() {
  // Helper must be defined inside getStaticPaths for Astro build
  const extractSlug = (id: string) => id.replace(/^fr\//, '').replace(/\.md$/, '');

  const posts = await getCollection('blog', ({ data }) => {
    return data.lang === 'fr' && !data.draft;
  });

  return posts.map((post) => ({
    params: { slug: extractSlug(post.id) },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);
const currentSlug = getSlugFromId(post.id);

// Get related posts
const allPosts = await getCollection('blog', ({ data }) => {
  return data.lang === lang && !data.draft;
});

// Find related posts: same category, or explicitly linked
let relatedPosts: typeof allPosts = [];
if (post.data.relatedPosts && post.data.relatedPosts.length > 0) {
  relatedPosts = allPosts.filter(p =>
    post.data.relatedPosts?.includes(getSlugFromId(p.id)) && p.id !== post.id
  );
} else if (post.data.category) {
  relatedPosts = allPosts
    .filter(p => p.data.category === post.data.category && p.id !== post.id)
    .slice(0, 3);
}

// Get pillar page if this is a cluster article
let pillarPost: typeof allPosts[0] | null = null;
if (post.data.pillarSlug) {
  pillarPost = allPosts.find(p => getSlugFromId(p.id) === post.data.pillarSlug) || null;
}

// Format dates
const publishDate = post.data.publishDate.toLocaleDateString('fr-FR', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const updatedDate = post.data.updatedDate?.toLocaleDateString('fr-FR', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Category labels
const categoryLabels: Record<string, string> = {
  guides: 'üìö Guide',
  comparatifs: '‚öñÔ∏è Comparatif',
  astuces: 'üí° Astuces',
  recettes: 'üçΩÔ∏è Recettes',
  temoignages: 'üí¨ T√©moignage',
};

// FAQ Schema for Google Rich Results
const faqSchema = post.data.faq && post.data.faq.length > 0 ? {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": post.data.faq.map(item => ({
    "@type": "Question",
    "name": item.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": item.answer
    }
  }))
} : null;
---

<BlogLayout
  title={post.data.title}
  description={post.data.description}
  keywords={post.data.tags?.join(', ')}
  lang={lang}
  publishDate={post.data.publishDate}
  updatedDate={post.data.updatedDate}
  author={post.data.author}
  authorRole={post.data.authorRole}
  image={resolveImageUrl(post.data.image)}
  imageAlt={post.data.imageAlt}
  category={post.data.category}
  readingTime={post.data.readingTime}
  translations={post.data.translations}
>
  <article class="py-8 md:py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Breadcrumb -->
      <nav class="mb-8 text-sm" style="color: var(--blog-text-secondary);">
        <a href="/" class="hover:underline">Accueil</a>
        <span class="mx-2">/</span>
        <a href="/blog/" class="hover:underline">Blog</a>
        <span class="mx-2">/</span>
        <span style="color: var(--blog-text);">{post.data.title}</span>
      </nav>

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
        <!-- Main Content -->
        <div class="lg:col-span-8">
          <!-- Header -->
          <header class="mb-8">
            {post.data.category && (
              <span class="blog-card-category mb-4">
                {categoryLabels[post.data.category] || post.data.category}
              </span>
            )}

            <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold leading-tight mb-6" style="color: var(--blog-text);">
              {post.data.title}
            </h1>

            <p class="text-lg md:text-xl mb-6" style="color: var(--blog-text-secondary);">
              {post.data.description}
            </p>

            <!-- Meta -->
            <div class="flex flex-wrap items-center gap-4 text-sm pb-6" style="color: var(--blog-text-muted); border-bottom: 1px solid var(--blog-border);">
              <span class="flex items-center gap-1">
                <span class="material-symbols-outlined text-base">person</span>
                {post.data.author || '√âquipe LOWIS'}
              </span>
            </div>
          </header>

          <!-- Hero Image -->
          {post.data.image && (
            <img
              src={resolveImageUrl(post.data.image)}
              alt={post.data.imageAlt || post.data.title}
              class="w-full aspect-video object-cover rounded-xl mb-8"
              style="box-shadow: var(--blog-shadow-lg);"
            />
          )}

          <!-- Link to Pillar (if cluster article) -->
          {pillarPost && (
            <div class="mb-8 p-4 rounded-xl" style="background: var(--blog-accent-light); border: 1px solid var(--blog-accent);">
              <p class="text-sm mb-2" style="color: var(--blog-text-secondary);">
                üìö Cet article fait partie de notre guide complet:
              </p>
              <a
                href={`/blog/${getSlugFromId(pillarPost.id)}/`}
                class="font-semibold hover:underline"
                style="color: var(--blog-accent);"
              >
                {pillarPost.data.title} ‚Üí
              </a>
            </div>
          )}

          <!-- Content -->
          <div class="blog-content">
            <Content />
          </div>

          <!-- FAQ Section (if exists) -->
          {post.data.faq && post.data.faq.length > 0 && (
            <section class="mt-12 mb-8">
              <h2 class="text-2xl font-bold mb-6" style="color: var(--blog-text);">
                Questions fr√©quentes
              </h2>
              <div class="space-y-4">
                {post.data.faq.map((item, index) => (
                  <details
                    class="group rounded-xl overflow-hidden"
                    style="background: var(--blog-surface); border: 1px solid var(--blog-border);"
                  >
                    <summary class="flex items-center justify-between p-5 cursor-pointer list-none font-semibold" style="color: var(--blog-text);">
                      <span class="pr-4">{item.question}</span>
                      <span class="material-symbols-outlined text-[var(--blog-text-secondary)] group-open:rotate-180 transition-transform duration-300">
                        expand_more
                      </span>
                    </summary>
                    <div class="px-5 pb-5">
                      <p style="color: var(--blog-text-secondary);" set:html={item.answer}></p>
                    </div>
                  </details>
                ))}
              </div>
            </section>
          )}

          <!-- FAQ Schema for SEO -->
          {faqSchema && (
            <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />
          )}

          <!-- Inline CTA (after content) -->
          <CTABanner lang={lang} type="plan" variant="gradient" />

          <!-- Author Box -->
          <AuthorBox
            author={post.data.author || '√âquipe LOWIS'}
            authorRole={post.data.authorRole}
            lang={lang}
          />

          <!-- Related Posts -->
          <RelatedPosts posts={relatedPosts} lang={lang} />
        </div>

        <!-- Sidebar (Desktop only) -->
        <aside class="hidden lg:block lg:col-span-4">
          <div class="sticky top-24">
            <!-- Table of Contents placeholder -->
            <div class="mb-8 p-6 rounded-xl" style="background: var(--blog-surface); border: 1px solid var(--blog-border);">
              <h3 class="font-bold mb-4" style="color: var(--blog-text);">
                Dans cet article
              </h3>
              <p class="text-sm" style="color: var(--blog-text-secondary);">
                Table des mati√®res g√©n√©r√©e automatiquement √† partir des titres de l'article.
              </p>
            </div>

            <!-- Sidebar CTA -->
            <div class="p-6 rounded-xl" style="background: var(--blog-accent-light); border: 1px solid var(--blog-accent);">
              <h3 class="font-bold mb-2" style="color: var(--blog-text);">
                Pr√™t √† commencer ?
              </h3>
              <p class="text-sm mb-4" style="color: var(--blog-text-secondary);">
                Cr√©ez votre plan personnalis√© gratuitement en 2 minutes.
              </p>
              <a
                href="/#pricing"
                class="inline-flex items-center gap-2 w-full justify-center px-4 py-2.5 rounded-lg font-semibold text-white"
                style="background: var(--blog-accent);"
              >
                Commencer
                <span class="material-symbols-outlined text-lg">arrow_forward</span>
              </a>
            </div>

            <!-- Tags -->
            {post.data.tags && post.data.tags.length > 0 && (
              <div class="mt-8">
                <h3 class="font-bold mb-3 text-sm uppercase tracking-wider" style="color: var(--blog-text-muted);">
                  Tags
                </h3>
                <div class="flex flex-wrap gap-2">
                  {post.data.tags.map((tag) => (
                    <span class="text-xs px-3 py-1 rounded-full" style="background: var(--blog-surface); border: 1px solid var(--blog-border); color: var(--blog-text-secondary);">
                      #{tag}
                    </span>
                  ))}
                </div>
              </div>
            )}
          </div>
        </aside>
      </div>
    </div>
  </article>
</BlogLayout>
