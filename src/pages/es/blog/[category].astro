---
/**
 * Blog Category Page - Spanish
 *
 * /es/blog/[category]/ - SEO silo pages for each category
 * Dedicated landing pages for category-based SEO positioning
 *
 * NEW URL STRUCTURE (removed /category/ from path):
 * - Before: /es/blog/category/guides/
 * - After:  /es/blog/guides/
 */
import { getCollection } from 'astro:content';
import BlogLayout from '../../../layouts/BlogLayout.astro';
import CTABanner from '../../../components/blog/CTABanner.astro';
import { getBlogImageUrl } from '../../../lib/storage';

const lang = 'es';

// List of all valid categories (used to differentiate from post slugs)
const VALID_CATEGORIES = ['guides', 'comparatifs', 'astuces', 'recettes', 'temoignages', 'bien-etre', 'mindset', 'sante-femme'];

// Category configuration with SEO data
const categoryConfig: Record<string, {
  label: string;
  icon: string;
  color: string;
  title: string;
  description: string;
  keywords: string;
}> = {
  guides: {
    label: 'Guías',
    icon: 'menu_book',
    color: '#059669',
    title: 'Guías de Nutrición y Pérdida de Peso | Blog LOWIS',
    description: 'Guías completas sobre nutrición, pérdida de peso y bienestar. Consejos expertos y planes personalizados con la IA de LOWIS.',
    keywords: 'guía nutrición, guía pérdida peso, consejos dieta, nutrición, plan alimenticio'
  },
  comparatifs: {
    label: 'Comparativas',
    icon: 'compare',
    color: '#7C3AED',
    title: 'Comparativas Apps Nutrición | LOWIS vs Alternativas',
    description: 'Comparaciones detalladas entre LOWIS y otras aplicaciones de nutrición. Descubre qué app se adapta mejor a tus necesidades.',
    keywords: 'comparativa app nutrición, alternativa myfitnesspal, yazio opiniones, lose it comparación, mejor app calorías'
  },
  astuces: {
    label: 'Tips',
    icon: 'lightbulb',
    color: '#F59E0B',
    title: 'Tips de Nutrición y Adelgazamiento | Consejos Prácticos',
    description: 'Tips prácticos para perder peso de forma efectiva. Consejos diarios para una alimentación saludable.',
    keywords: 'tips adelgazar, consejos pérdida peso, tips nutrición, hábitos saludables, alimentación equilibrada'
  },
  recettes: {
    label: 'Recetas',
    icon: 'restaurant',
    color: '#EF4444',
    title: 'Recetas Saludables y Equilibradas | Cocina Healthy',
    description: 'Recetas saludables para toda la familia. Platos deliciosos y nutritivos para tu dieta.',
    keywords: 'recetas saludables, cocina sana, recetas dieta, platos bajos calorías, recetas dietéticas'
  },
  temoignages: {
    label: 'Testimonios',
    icon: 'chat',
    color: '#3B82F6',
    title: 'Testimonios y Resultados | Éxitos LOWIS',
    description: 'Descubre los testimonios de nuestros usuarios y sus resultados con LOWIS. Historias de transformación reales.',
    keywords: 'testimonios pérdida peso, resultados dieta, antes después, historias éxito, transformación'
  },
  'bien-etre': {
    label: 'Bienestar',
    icon: 'self_improvement',
    color: '#10B981',
    title: 'Bienestar y Salud Mental | Blog LOWIS',
    description: 'Artículos sobre bienestar, gestión del estrés y salud mental. Descubre cómo tu mente influye en tu peso.',
    keywords: 'bienestar, salud mental, estrés pérdida peso, sueño dieta, equilibrio vida'
  },
  mindset: {
    label: 'Mindset',
    icon: 'psychology',
    color: '#8B5CF6',
    title: 'Mindset y Reprogramación Mental | Blog LOWIS',
    description: 'Artículos sobre mindset, reprogramación mental y psicología de la pérdida de peso. Cambia tu relación con la comida.',
    keywords: 'mindset pérdida peso, psicología alimentación, reprogramación mental, hábitos alimenticios'
  },
  'sante-femme': {
    label: 'Salud Femenina',
    icon: 'female',
    color: '#EC4899',
    title: 'Salud Femenina y Nutrición | Blog LOWIS',
    description: 'Artículos sobre salud femenina, ciclo menstrual y alimentación adaptada a mujeres. Nutrición personalizada según tus hormonas.',
    keywords: 'salud mujer, ciclo menstrual alimentación, hormonas peso, nutrición femenina, dieta mujer'
  },
};

// Generate static paths for all categories
export async function getStaticPaths() {
  const categories = ['guides', 'comparatifs', 'astuces', 'recettes', 'temoignages', 'bien-etre', 'mindset', 'sante-femme'];
  return categories.map((category) => ({
    params: { category },
  }));
}

const { category } = Astro.params;
const config = categoryConfig[category];

if (!config) {
  return Astro.redirect('/es/blog/');
}

/**
 * Resolve image path to full URL
 */
function resolveImageUrl(imagePath: string | undefined): string | undefined {
  if (!imagePath) return undefined;
  if (imagePath.startsWith('http') || imagePath.startsWith('/')) return imagePath;
  return getBlogImageUrl(imagePath);
}

// Helper to extract slug from post id
function getSlugFromId(id: string): string {
  return id.replace(/^es\//, '').replace(/\.md$/, '');
}

// Get all Spanish blog posts in this category
const allPosts = await getCollection('blog', ({ data }) => {
  return data.lang === lang && !data.draft && data.category === category;
});

// Sort by publish date (newest first)
const posts = allPosts.sort((a, b) =>
  b.data.publishDate.getTime() - a.data.publishDate.getTime()
);

// Get all posts for category counts (for navigation)
const allBlogPosts = await getCollection('blog', ({ data }) => {
  return data.lang === lang && !data.draft;
});

// Get used categories for navigation pills
const usedCategories = [...new Set(allBlogPosts.map(p => p.data.category).filter(Boolean))] as string[];
---

<BlogLayout
  title={config.title}
  description={config.description}
  keywords={config.keywords}
  lang={lang}
>
  <!-- Category Hero -->
  <section class="py-12 md:py-16" style="background: var(--blog-bg);">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <!-- Category badge -->
      <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-white font-medium mb-6 notranslate" translate="no" style={`background: ${config.color};`}>
        <span class="material-symbols-outlined">{config.icon}</span>
        {config.label}
      </div>

      <h1 class="text-4xl md:text-5xl font-bold mb-6 tracking-tight" style="color: var(--blog-text);">
        {config.label}
      </h1>
      <p class="text-lg md:text-xl max-w-2xl mx-auto leading-relaxed" style="color: var(--blog-text-secondary);">
        {config.description}
      </p>

      <!-- Breadcrumb -->
      <nav class="mt-8 text-sm" style="color: var(--blog-text-muted);">
        <a href="/es/blog/" class="hover:underline" style="color: var(--blog-accent);">Blog</a>
        <span class="mx-2">›</span>
        <span>{config.label}</span>
      </nav>
    </div>
  </section>

  <!-- Category Navigation Pills -->
  {usedCategories.length > 0 && (
    <section class="pb-8" style="background: var(--blog-bg);">
      <div class="max-w-6xl mx-auto">
        <div class="category-scroll-container overflow-x-auto scrollbar-hide px-4 sm:px-6 lg:px-8">
          <div class="flex items-center gap-2 md:gap-3 md:justify-center min-w-max md:min-w-0">
            <a
              href="/es/blog/"
              class="category-pill inline-flex items-center gap-1.5 px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 whitespace-nowrap notranslate"
              translate="no"
            >
              <span class="material-symbols-outlined text-base">apps</span>
              Todos
            </a>
            {usedCategories.map((cat) => {
              const catConfig = categoryConfig[cat];
              if (!catConfig) return null;
              const isActive = cat === category;
              return (
                <a
                  href={`/es/blog/${cat}/`}
                  class={`category-pill inline-flex items-center gap-1.5 px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 whitespace-nowrap notranslate ${isActive ? 'active' : ''}`}
                  translate="no"
                  style={isActive ? `background: ${catConfig.color}; border-color: ${catConfig.color}; color: white;` : ''}
                >
                  <span class="material-symbols-outlined text-base">{catConfig.icon}</span>
                  {catConfig.label}
                </a>
              );
            })}
          </div>
        </div>
      </div>
    </section>
  )}

  <!-- Posts Section -->
  <section class="pb-16 md:pb-24">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      {posts.length > 0 ? (
        <>
          <!-- Posts count -->
          <div class="flex items-center justify-between mb-8">
            <p class="text-sm font-medium" style="color: var(--blog-text-muted);">
              {posts.length} artículo{posts.length > 1 ? 's' : ''} en esta categoría
            </p>
          </div>

          <!-- Posts Grid -->
          <div class="grid gap-6 md:gap-8 sm:grid-cols-2 lg:grid-cols-3">
            {posts.map((post) => (
              <a
                href={`/es/blog/${getSlugFromId(post.id)}/`}
                class="group block"
              >
                <article class="h-full rounded-xl overflow-hidden transition-all duration-300 group-hover:shadow-lg group-hover:-translate-y-1" style="background: var(--blog-surface); border: 1px solid var(--blog-border);">
                  <!-- Image -->
                  <div class="relative aspect-[16/10] overflow-hidden">
                    {post.data.image ? (
                      <img
                        src={resolveImageUrl(post.data.image)}
                        alt={post.data.imageAlt || post.data.title}
                        class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                        loading="lazy"
                      />
                    ) : (
                      <div class="w-full h-full flex items-center justify-center" style={`background: linear-gradient(135deg, ${config.color}20, var(--blog-surface));`}>
                        <span class="material-symbols-outlined" style={`font-size: 3rem; color: ${config.color}; opacity: 0.5;`}>article</span>
                      </div>
                    )}
                    <!-- Category badge -->
                    <span
                      class="absolute top-3 left-3 inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium text-white notranslate"
                      translate="no"
                      style={`background: ${config.color};`}
                    >
                      <span class="material-symbols-outlined text-xs">{config.icon}</span>
                      {config.label}
                    </span>
                  </div>

                  <!-- Content -->
                  <div class="p-5">
                    {post.data.readingTime && (
                      <div class="flex items-center gap-2 mb-2">
                        <span class="text-xs" style="color: var(--blog-text-muted);">
                          {post.data.readingTime} min de lectura
                        </span>
                      </div>
                    )}
                    <h2 class="font-bold text-lg mb-2 leading-snug group-hover:text-[var(--blog-accent)] transition-colors line-clamp-2" style="color: var(--blog-text);">
                      {post.data.title}
                    </h2>
                    <p class="text-sm leading-relaxed line-clamp-2" style="color: var(--blog-text-secondary);">
                      {post.data.description}
                    </p>
                  </div>
                </article>
              </a>
            ))}
          </div>
        </>
      ) : (
        <!-- Empty state -->
        <div class="text-center py-20">
          <div class="inline-flex items-center justify-center w-20 h-20 rounded-full mb-6" style={`background: ${config.color}20;`}>
            <span class="material-symbols-outlined text-4xl" style={`color: ${config.color};`}>{config.icon}</span>
          </div>
          <h2 class="text-2xl font-bold mb-3" style="color: var(--blog-text);">
            Próximamente
          </h2>
          <p class="mb-8 max-w-md mx-auto" style="color: var(--blog-text-secondary);">
            Los artículos de {config.label.toLowerCase()} llegarán muy pronto. ¡Mientras tanto, descubre nuestros otros contenidos!
          </p>
          <a
            href="/es/blog/"
            class="inline-flex items-center gap-2 px-6 py-3 rounded-xl font-semibold text-white transition-transform hover:scale-105"
            style="background: var(--blog-accent);"
          >
            Ver todos los artículos
            <span class="material-symbols-outlined">arrow_forward</span>
          </a>
        </div>
      )}
    </div>
  </section>

  <!-- Related Categories -->
  <section class="py-12" style="background: var(--blog-surface);">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-lg font-semibold mb-6 text-center" style="color: var(--blog-text);">
        Otras categorías
      </h2>
      <div class="flex flex-wrap justify-center gap-3">
        {Object.entries(categoryConfig).map(([key, cat]) => (
          key !== category && (
            <a
              href={`/es/blog/${key}/`}
              class="inline-flex items-center gap-1.5 px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 hover:scale-105 notranslate"
              translate="no"
              style={`background: ${cat.color}15; color: ${cat.color}; border: 1px solid ${cat.color}30;`}
            >
              <span class="material-symbols-outlined text-base">{cat.icon}</span>
              {cat.label}
            </a>
          )
        ))}
      </div>
    </div>
  </section>

  <!-- Bottom CTA -->
  <section class="py-16" style="background: var(--blog-bg);">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <CTABanner lang={lang} type="trial" variant="gradient" />
    </div>
  </section>
</BlogLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Horizontal scroll container - hide scrollbar */
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  /* Category pill styles */
  .category-pill {
    background: var(--blog-surface);
    border: 1px solid var(--blog-border);
    color: var(--blog-text-secondary);
    cursor: pointer;
    flex-shrink: 0;
  }
  .category-pill:hover {
    border-color: var(--blog-accent);
    color: var(--blog-accent);
  }
  .category-pill.active {
    color: white;
  }
</style>
